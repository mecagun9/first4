<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>ì‚¼êµ­ì§€3 ìŠ¤íƒ€ì¼ (ëª¨ë°”ì¼ ìµœì í™”)</title>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<style>
  :root{
    --tap:56px;         /* ëª¨ë°”ì¼ í„°ì¹˜ íƒ€ê¹ƒ ìµœì í™” */
    --gap:12px;
    --font-lg:16px;
    --font-md:14px;
    --font-sm:12px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background:#11161c;
    color:#eaeaea;
    font-family:system-ui,apple-system,Segoe UI,Roboto,sans-serif;
    overflow-x:hidden;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
  }

  /* ëª¨ë°”ì¼ ìš°ì„  ë ˆì´ì•„ì›ƒ */
  #wrap{
    display:flex;
    flex-direction:column;
    min-height:100vh;
  }

  /* ìƒë‹¨ ê³ ì • ì •ë³´ë°” - ì•„ì´í° SE3 ìµœì í™” */
  #topBar{
    position:sticky;
    top:0;
    z-index:100;
    background:#0a0f16;
    border-bottom:1px solid #2a2e38;
    padding:4px var(--gap);
    display:grid;
    grid-template-columns:1fr 1fr 1fr auto;
    gap:4px;
    align-items:center;
    min-height:44px;
  }

  /* ë§µ ì˜ì—­ - ì•„ì´í° SE3 ìµœì í™” */
  #mapContainer{
    flex:1;
    position:relative;
    height:50vh; /* ì•„ì´í° SE3ëŠ” ì„¸ë¡œê°€ ì§§ìœ¼ë¯€ë¡œ ê³ ì • ë†’ì´ */
    background:#0f1115;
    border-bottom:1px solid #2a2e38;
    overflow:auto;
    -webkit-overflow-scrolling:touch;
  }

  #mapWrapper{
    position:relative;
    min-width:100%;
    min-height:100%;
  }

  canvas{
    display:block;
    background:#0f1115;
    touch-action: none;
    position:relative;
  }

  /* ìŠ¤í¬ë¡¤ ì¸ë””ì¼€ì´í„° */
  .scroll-indicator{
    position:absolute;
    background:rgba(139,208,255,0.3);
    border-radius:4px;
    pointer-events:none;
    transition:opacity 0.3s ease;
    opacity:0;
  }
  .scroll-indicator.show{opacity:1}
  .scroll-indicator.horizontal{
    bottom:4px;
    left:4px;
    right:4px;
    height:6px;
  }
  .scroll-indicator.vertical{
    top:4px;
    right:4px;
    bottom:4px;
    width:6px;
  }
  .scroll-thumb{
    background:#8bd0ff;
    border-radius:4px;
    position:absolute;
    transition:all 0.1s ease;
  }

  /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ íŒ¨ë„ - ì•„ì´í° SE3 ìµœì í™” */
  #controls{
    background:#141a22;
    border-top:1px solid #2a2e38;
    padding:var(--gap);
    max-height:50vh; /* ë‚¨ì€ ê³µê°„ í™œìš© */
    overflow-y:auto;
  }

  /* íƒ­ ì‹œìŠ¤í…œ - ì•„ì´í° SE3 ìµœì í™” */
  .tabs{
    display:grid;
    grid-template-columns:1fr 1fr 1fr;
    margin-bottom:var(--gap);
    border-radius:6px;
    background:#0a0f16;
    overflow:hidden;
  }
  .tab{
    padding:8px 4px;
    background:#1a2332;
    border:none;
    color:#ccc;
    font-size:var(--font-sm);
    cursor:pointer;
    border-right:1px solid #2a2e38;
    text-align:center;
    min-height:36px;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .tab:last-child{border-right:none}
  .tab.active{background:#2a4d6b;color:#fff}
  .tab-content{display:none}
  .tab-content.active{display:block}

  .panel{
    background:#1a2332;
    border:1px solid #2a2e38;
    border-radius:6px;
    padding:8px;
    margin-bottom:var(--gap);
  }
  
  h3{
    margin:0 0 6px 0;
    font-size:var(--font-md);
    color:#8bd0ff;
  }

  .row{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:6px;
    margin-bottom:6px;
  }
  .row.triple{
    grid-template-columns:1fr 1fr 1fr;
  }
  .row.single{
    grid-template-columns:1fr;
  }
  
  button{
    min-height:var(--tap);
    min-width:60px;
    padding:8px 12px;
    border-radius:6px;
    border:1px solid #445169;
    background:#223048;
    color:#fff;
    font-size:var(--font-sm);
    cursor:pointer;
    white-space:nowrap;
    text-align:center;
  }
  button:disabled{opacity:.5;cursor:not-allowed}
  .ghost{background:#1b2433;border-style:dashed}
  .full{grid-column:1/-1}
  .compact{min-width:auto;padding:6px 10px;font-size:var(--font-xs)}

  label, .kv{font-size:var(--font-sm);line-height:1.3}
  input[type="number"]{
    width:60px;
    height:36px;
    font-size:var(--font-sm);
    padding:0 6px;
    border-radius:4px;
    border:1px solid #2a2e38;
    background:#0f1115;
    color:#fff;
  }
  input[type="checkbox"]{
    width:18px;
    height:18px;
    transform:translateY(1px);
    accent-color:#5aaeff;
  }
  
  .muted{opacity:.75;font-size:var(--font-xs)}
  
  .chip{
    display:inline-block;
    min-height:28px;
    border-radius:14px;
    padding:4px 8px;
    border:1px solid #2a2e38;
    background:#10161f;
    font-size:var(--font-xs);
    margin:1px 2px 1px 0;
    white-space:nowrap;
    text-align:center;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  /* ë¡œê·¸ ì˜ì—­ - ì•„ì´í° SE3 ìµœì í™” */
  #log{
    height:120px;
    overflow:auto;
    font-size:var(--font-xs);
    line-height:1.3;
    padding:6px;
    background:#0f141c;
    border:1px solid #2a2e38;
    border-radius:4px;
  }

  /* ì„ íƒëœ ê±°ì  ì •ë³´ - ì•„ì´í° SE3 ìµœì í™” */
  #selectedInfo{
    position:fixed;
    bottom:16px;
    left:50%;
    transform:translateX(-50%);
    max-width:calc(100vw - 32px);
    background:#1a2332;
    border:2px solid #ffd76b;
    border-radius:8px;
    padding:8px;
    font-size:var(--font-xs);
    z-index:200;
    display:none;
    box-shadow:0 2px 8px rgba(0,0,0,0.4);
    text-align:center;
  }

  /* ì „íˆ¬ ì˜¤ë²„ë ˆì´ - ì•„ì´í° SE3 ìµœì í™” */
  #battleOverlay{
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    background:rgba(0,0,0,.85);
    z-index:9999;
    padding:16px;
  }
  #battleBox{
    width:100%;
    max-width:360px;
    max-height:85vh;
    overflow:auto;
    background:#141a22;
    border:1px solid #2a2e38;
    border-radius:8px;
    padding:12px;
  }
  .barWrap{
    background:#0f141c;
    border:1px solid #2a2e38;
    border-radius:6px;
    height:20px;
    width:100%;
  }
  .barFillAtt{
    height:100%;
    background:#2fb36b;
    border-radius:6px;
    transition:width .35s;
  }
  .barFillDef{
    height:100%;
    background:#d94a4a;
    border-radius:6px;
    transition:width .35s;
  }
  .barLabel{
    display:flex;
    justify-content:space-between;
    font-size:var(--font-xs);
    margin-top:3px;
    margin-bottom:3px;
  }

  /* ë°˜ì‘í˜• ì¡°ì • - ì•„ì´í° SE3 ê¸°ì¤€ */
  @media (max-width:375px){
    :root{--tap:44px;--font-lg:14px;--font-md:12px;--font-sm:10px;--font-xs:9px;--gap:6px}
    #topBar{padding:2px var(--gap);min-height:40px;grid-template-columns:repeat(4,1fr)}
    .chip{padding:2px 6px;min-height:24px;font-size:9px}
    button{padding:6px 8px;font-size:10px;min-height:40px}
    .panel{padding:6px}
    h3{font-size:12px}
    input[type="number"]{width:50px;height:32px;font-size:10px}
    #log{height:100px;font-size:9px}
    .tab{padding:6px 2px;min-height:32px;font-size:10px}
  }
  @media (min-width:376px) and (max-width:414px){
    :root{--tap:48px;--font-lg:15px;--font-md:13px;--font-sm:11px;--font-xs:10px}
  }
  @media (min-width:415px) and (max-width:768px){
    :root{--tap:52px;--font-lg:16px;--font-md:14px;--font-sm:12px}
    #mapContainer{height:55vh}
  }
  @media (min-width:768px){
    :root{--tap:48px;--font-lg:18px;--font-md:16px}
    #wrap{flex-direction:row}
    #mapContainer{flex:2;height:70vh;border-bottom:none;border-right:1px solid #2a2e38}
    #controls{flex:1;max-width:400px;border-top:none;border-left:1px solid #2a2e38;max-height:none}
    #selectedInfo{position:static;transform:none;max-width:none;margin-bottom:var(--gap)}
    .row{display:flex;gap:8px}
    .row.triple{display:flex}
    .row.single{display:flex}
  })}
    .chip{padding:6px 10px;min-height:32px;font-size:11px}
    button{padding:10px 14px;font-size:var(--font-sm)}
    .panel{padding:10px}
    h3{font-size:14px}
    input[type="number"]{width:70px;height:40px;font-size:var(--font-sm)}
  }
  @media (min-width:481px) and (max-width:768px){
    :root{--tap:56px;--font-lg:16px;--font-md:14px;--font-sm:12px}
  }
  @media (min-width:768px){
    :root{--tap:48px;--font-lg:18px;--font-md:16px}
    #wrap{flex-direction:row}
    #mapContainer{flex:2;min-height:70vh;border-bottom:none;border-right:1px solid #2a2e38}
    #controls{flex:1;max-width:400px;border-top:none;border-left:1px solid #2a2e38}
    #selectedInfo{position:static;transform:none;max-width:none;margin-bottom:var(--gap)}
  }

  /* ì§„ë™ í”¼ë“œë°± íš¨ê³¼ */
  .shake{
    animation:shake 0.2s ease-in-out;
  }
  @keyframes shake{
    0%,100%{transform:translateX(0)}
    25%{transform:translateX(-2px)}
    75%{transform:translateX(2px)}
  }

  /* í„°ì¹˜ í”¼ë“œë°± */
  .touch-feedback{
    position:relative;
    overflow:hidden;
  }
  .touch-feedback::after{
    content:'';
    position:absolute;
    top:50%;
    left:50%;
    width:0;
    height:0;
    border-radius:50%;
    background:rgba(255,255,255,0.3);
    transform:translate(-50%,-50%);
    transition:width 0.3s ease,height 0.3s ease;
  }
  .touch-feedback.active::after{
    width:100px;
    height:100px;
  }
</style>
</head>
<body>

<!-- ìƒë‹¨ ì •ë³´ë°” -->
<div id="topBar">
  <div class="chip">í„´: <b id="turn">1</b></div>
  <div class="chip">ê¸ˆ: <b id="gold">200</b> G</div>
  <div class="chip">ìˆ˜ì…: <b id="income">0</b> G/í„´</div>
  <button id="btnEndTurn" class="compact">í„´ ì¢…ë£Œ â–¶</button>
</div>

<div id="wrap">
  <!-- ë§µ ì˜ì—­ -->
  <div id="mapContainer">
    <div id="mapWrapper">
      <canvas id="map" aria-label="ì „ëµ ì§€ë„"></canvas>
      <!-- ìŠ¤í¬ë¡¤ ì¸ë””ì¼€ì´í„° -->
      <div class="scroll-indicator horizontal">
        <div class="scroll-thumb" id="hThumb"></div>
      </div>
      <div class="scroll-indicator vertical">
        <div class="scroll-thumb" id="vThumb"></div>
      </div>
    </div>
  </div>

  <!-- í•˜ë‹¨ ì»¨íŠ¸ë¡¤ -->
  <div id="controls">
    <!-- íƒ­ ë©”ë‰´ -->
    <div class="tabs">
      <button class="tab active" data-tab="info">ì •ë³´</button>
      <button class="tab" data-tab="commands">ëª…ë ¹</button>
      <button class="tab" data-tab="log">ë¡œê·¸</button>
    </div>

    <!-- ì •ë³´ íƒ­ -->
    <div class="tab-content active" data-content="info">
      <div class="panel">
        <h3>ê±°ì  ì •ë³´</h3>
        <div id="cityInfo" class="kv">ê±°ì ì„ í„°ì¹˜í•˜ì„¸ìš”.</div>
      </div>
      <div class="kv muted">ë¹„ìš©: ë³´ë³‘ 1G / ê¶ìˆ˜ 2G / ê¸°ë³‘ 3G<br>ìš”ìƒˆí™” 10G (+1 ë°©ì–´, ìµœëŒ€ +5)</div>
    </div>

    <!-- ëª…ë ¹ íƒ­ -->
    <div class="tab-content" data-content="commands">
      <div class="row">
        <button id="btnMove" class="touch-feedback">ì´ë™</button>
        <button id="btnRecruit" class="touch-feedback">ëª¨ì§‘</button>
      </div>
      <div class="row">
        <button id="btnFortify" class="touch-feedback">ìš”ìƒˆí™”</button>
        <button id="btnCancel" class="ghost touch-feedback">ì·¨ì†Œ</button>
      </div>
      <div id="cmdArea"></div>
    </div>

    <!-- ë¡œê·¸ íƒ­ -->
    <div class="tab-content" data-content="log">
      <div id="log" role="log" aria-live="polite"></div>
    </div>
  </div>
</div>

<!-- ì„ íƒëœ ê±°ì  ì •ë³´ (ëª¨ë°”ì¼ ì „ìš©) -->
<div id="selectedInfo"></div>

<!-- ì „íˆ¬ ì˜¤ë²„ë ˆì´ -->
<div id="battleOverlay">
  <div id="battleBox">
    <h3>ì „íˆ¬</h3>
    <div id="battleHeader" class="kv" style="margin-bottom:8px">ê³µê²©: ? â†’ ë°©ì–´: ?</div>

    <div class="row" style="gap:8px;margin-bottom:12px">
      <div class="chip">ê³µê²© ì˜ì›…: <b id="attHeroName">ì—†ìŒ</b></div>
      <div class="chip">ë°©ì–´ ì˜ì›…: <b id="defHeroName">ì—†ìŒ</b></div>
    </div>

    <div style="margin-bottom:8px">
      <div class="barLabel"><span>ê³µê²© ì „íˆ¬ë ¥</span><span id="attPctTxt">0%</span></div>
      <div class="barWrap"><div id="barAtt" class="barFillAtt" style="width:0%"></div></div>
    </div>
    <div style="margin-bottom:16px">
      <div class="barLabel"><span>ìˆ˜ë¹„ ì „íˆ¬ë ¥</span><span id="defPctTxt">0%</span></div>
      <div class="barWrap"><div id="barDef" class="barFillDef" style="width:0%"></div></div>
    </div>

    <div class="row" style="margin-bottom:12px">
      <button id="btnBattleRound" class="touch-feedback">ë¼ìš´ë“œ</button>
      <button id="btnBattleAuto" class="touch-feedback">ìë™</button>
    </div>
    <div class="row" style="margin-bottom:12px">
      <button id="btnBattleRetreat" class="ghost touch-feedback">í‡´ê°</button>
      <button id="btnBattleFinish" class="touch-feedback" disabled>ì™„ë£Œ</button>
    </div>

    <div id="battleLog" style="height:200px;overflow:auto;font-size:var(--font-sm);line-height:1.4;background:#0f141c;border:1px solid #2a2e38;border-radius:8px;padding:8px"></div>
  </div>
</div>

<script>
/* ===== ëª¨ë°”ì¼ ìœ í‹¸ë¦¬í‹° ===== */
function addTouchFeedback(element) {
  element.addEventListener('touchstart', function() {
    this.classList.add('active');
    setTimeout(() => this.classList.remove('active'), 300);
  }, {passive: true});
}

function vibrate(pattern = [50]) {
  if ('vibrate' in navigator) {
    navigator.vibrate(pattern);
  }
}

/* ===== íƒ­ ì‹œìŠ¤í…œ ===== */
function initTabs() {
  const tabs = document.querySelectorAll('.tab');
  const contents = document.querySelectorAll('.tab-content');
  
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const target = tab.dataset.tab;
      
      tabs.forEach(t => t.classList.remove('active'));
      contents.forEach(c => c.classList.remove('active'));
      
      tab.classList.add('active');
      document.querySelector(`[data-content="${target}"]`).classList.add('active');
      
      vibrate([30]);
    });
  });
}

/* ===== ë§µ ìŠ¤í¬ë¡¤ë§ ì‹œìŠ¤í…œ ===== */
let mapScale = 1;
let mapOffsetX = 0;
let mapOffsetY = 0;
let canvasWidth = 1200;  // ê¸°ë³¸ ë§µ í¬ê¸° (ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì „ì²´ ì˜ì—­)
let canvasHeight = 800;
let viewportWidth = 400;
let viewportHeight = 400;

function initMapDimensions() {
  const container = document.getElementById('mapContainer');
  const canvas = document.getElementById('map');
  const wrapper = document.getElementById('mapWrapper');
  
  // ë·°í¬íŠ¸ í¬ê¸° ê³„ì‚°
  viewportWidth = container.clientWidth;
  viewportHeight = container.clientHeight;
  
  // ë””ë°”ì´ìŠ¤ í”½ì…€ ë¹„ìœ¨
  const dpr = window.devicePixelRatio || 1;
  
  // ëª¨ë°”ì¼ í•´ìƒë„ì— ë”°ë¥¸ ë§µ ìŠ¤ì¼€ì¼ ì¡°ì •
  if (window.innerWidth <= 480) {
    mapScale = 0.8;
    canvasWidth = 1000;
    canvasHeight = 700;
  } else if (window.innerWidth <= 768) {
    mapScale = 0.9;
    canvasWidth = 1100;
    canvasHeight = 750;
  } else {
    mapScale = 1;
    canvasWidth = 1200;
    canvasHeight = 800;
  }
  
  // ìº”ë²„ìŠ¤ ì‹¤ì œ í¬ê¸° ì„¤ì •
  canvas.width = canvasWidth * dpr;
  canvas.height = canvasHeight * dpr;
  
  // CSS í¬ê¸° ì„¤ì •
  canvas.style.width = canvasWidth + 'px';
  canvas.style.height = canvasHeight + 'px';
  
  // ë˜í¼ í¬ê¸° ì„¤ì • (ìŠ¤í¬ë¡¤ ì˜ì—­)
  wrapper.style.width = canvasWidth + 'px';
  wrapper.style.height = canvasHeight + 'px';
  
  // ì»¨í…ìŠ¤íŠ¸ ìŠ¤ì¼€ì¼ ì„¤ì •
  ctx.setTransform(dpr * mapScale, 0, 0, dpr * mapScale, 0, 0);
  
  // ì´ˆê¸° ì¤‘ì•™ ì •ë ¬
  centerMapOnPlayer();
}

function centerMapOnPlayer() {
  const playerCities = cities.filter(c => c.owner === PLAYER);
  if (playerCities.length > 0) {
    // í”Œë ˆì´ì–´ ê±°ì ë“¤ì˜ ì¤‘ì‹¬ ê³„ì‚°
    const centerX = playerCities.reduce((sum, c) => sum + c.x, 0) / playerCities.length;
    const centerY = playerCities.reduce((sum, c) => sum + c.y, 0) / playerCities.length;
    
    // ë·°í¬íŠ¸ ì¤‘ì•™ìœ¼ë¡œ ìŠ¤í¬ë¡¤
    const container = document.getElementById('mapContainer');
    container.scrollLeft = Math.max(0, (centerX * mapScale) - (viewportWidth / 2));
    container.scrollTop = Math.max(0, (centerY * mapScale) - (viewportHeight / 2));
  }
}

function updateScrollIndicators() {
  const container = document.getElementById('mapContainer');
  const hIndicator = container.querySelector('.scroll-indicator.horizontal');
  const vIndicator = container.querySelector('.scroll-indicator.vertical');
  const hThumb = document.getElementById('hThumb');
  const vThumb = document.getElementById('vThumb');
  
  const scrollLeft = container.scrollLeft;
  const scrollTop = container.scrollTop;
  const scrollWidth = container.scrollWidth;
  const scrollHeight = container.scrollHeight;
  const clientWidth = container.clientWidth;
  const clientHeight = container.clientHeight;
  
  // ê°€ë¡œ ìŠ¤í¬ë¡¤ ì¸ë””ì¼€ì´í„°
  if (scrollWidth > clientWidth) {
    const thumbWidth = Math.max(20, (clientWidth / scrollWidth) * clientWidth);
    const thumbLeft = (scrollLeft / (scrollWidth - clientWidth)) * (clientWidth - thumbWidth);
    
    hThumb.style.width = thumbWidth + 'px';
    hThumb.style.left = thumbLeft + 'px';
    hIndicator.classList.add('show');
  } else {
    hIndicator.classList.remove('show');
  }
  
  // ì„¸ë¡œ ìŠ¤í¬ë¡¤ ì¸ë””ì¼€ì´í„°
  if (scrollHeight > clientHeight) {
    const thumbHeight = Math.max(20, (clientHeight / scrollHeight) * clientHeight);
    const thumbTop = (scrollTop / (scrollHeight - clientHeight)) * (clientHeight - thumbHeight);
    
    vThumb.style.height = thumbHeight + 'px';
    vThumb.style.top = thumbTop + 'px';
    vIndicator.classList.add('show');
  } else {
    vIndicator.classList.remove('show');
  }
  
  // ì ì‹œ í›„ ìˆ¨ê¸°ê¸°
  clearTimeout(window.scrollIndicatorTimeout);
  window.scrollIndicatorTimeout = setTimeout(() => {
    hIndicator.classList.remove('show');
    vIndicator.classList.remove('show');
  }, 1500);
}

/* ===== ê¸°ì¡´ ê²Œì„ ë¡œì§ (ë³€ìˆ˜ë“¤) ===== */
const TYPES=["INF","ARC","CAV"];
const TRAIN_COST={INF:1,ARC:2,CAV:3};
const COUNTER={ INF:{INF:1.0,ARC:1.25,CAV:0.85}, ARC:{INF:0.9,ARC:1.0,CAV:1.25}, CAV:{INF:1.25,ARC:0.85,CAV:1.0} };

const heroes={
  H01:{id:"H01",name:"ê´€ì˜",inTransit:false,aura:{atkPct:0.10,defPct:0.05},advantage:{INF:0.20,ARC:0.10,CAV:0.00},moraleBoost:5},
  H02:{id:"H02",name:"ì¥ê´‘",inTransit:false,aura:{atkPct:0.05,defPct:0.10},advantage:{INF:0.00,ARC:0.20,CAV:0.10},moraleBoost:8}
};

const PLAYER="player", ENEMY="enemy", NEUT="neutral";
const cities=[
  {id:"PI",name:"ë¶í‰",   x:120,y:80,  owner:NEUT,   troops:{INF:6, ARC:1,CAV:1},defense:0,income:5,  adj:["JI"],heroId:null},
  {id:"JI",name:"ê³„(ê³„ì„±)",x:240,y:120, owner:PLAYER, troops:{INF:30,ARC:6,CAV:4},defense:1,income:12, adj:["PI","YE","BO"],heroId:"H01"},
  {id:"YE",name:"ì—…",     x:360,y:140, owner:PLAYER, troops:{INF:20,ARC:6,CAV:4},defense:1,income:10, adj:["JI","BO","PU"],heroId:null},
  {id:"BO",name:"ë°•",     x:280,y:240, owner:NEUT,   troops:{INF:12,ARC:2,CAV:1},defense:0,income:6,  adj:["JI","YE","PU","CH"],heroId:null},
  {id:"PU",name:"ë¶€",     x:440,y:220, owner:ENEMY,  troops:{INF:20,ARC:6,CAV:4},defense:1,income:9,  adj:["YE","BO","CH","LU"],heroId:"H02"},
  {id:"CH",name:"í—ˆ/ì°½",  x:360,y:320, owner:NEUT,   troops:{INF:8, ARC:1,CAV:1},defense:0,income:6,  adj:["BO","PU","LU","RU"],heroId:null},
  {id:"LU",name:"ë‚™ì–‘",   x:500,y:300, owner:ENEMY,  troops:{INF:18,ARC:4,CAV:3},defense:1,income:9,  adj:["PU","CH","RU"],heroId:null},
  {id:"RU",name:"ì—¬ë‚¨",   x:420,y:400, owner:NEUT,   troops:{INF:9, ARC:2,CAV:1},defense:0,income:6,  adj:["CH","LU","SH"],heroId:null},
  {id:"SH",name:"ìˆ˜ì¶˜",   x:520,y:460, owner:ENEMY,  troops:{INF:16,ARC:4,CAV:2},defense:1,income:8,  adj:["RU","GU"],heroId:null},
  {id:"GU",name:"ê´‘ë¦‰",   x:640,y:420, owner:NEUT,   troops:{INF:8, ARC:1,CAV:1},defense:0,income:6,  adj:["SH","QH"],heroId:null},
  {id:"QH",name:"ê±´ì—…",   x:740,y:480, owner:ENEMY,  troops:{INF:18,ARC:6,CAV:4},defense:1,income:10, adj:["GU","HU"],heroId:null},
  {id:"HU",name:"íšŒê³„",   x:840,y:560, owner:NEUT,   troops:{INF:7, ARC:2,CAV:1},defense:0,income:6,  adj:["QH"],heroId:null},
];

let turn=1,gold=200;
let movements=[];
let selectedId=null,mode="idle",moveFrom=null;

/* ===== ìœ í‹¸ í•¨ìˆ˜ë“¤ ===== */
const logEl=document.getElementById("log");
const byId=id=>cities.find(c=>c.id===id);
const sumTroops=t=>["INF","ARC","CAV"].reduce((s,k)=>s+(t[k]||0),0);
function addTroops(a,b){["INF","ARC","CAV"].forEach(k=>a[k]=(a[k]||0)+(b[k]||0));}
function subTroops(a,b){["INF","ARC","CAV"].forEach(k=>a[k]=(a[k]||0)-(b[k]||0));}
function cloneTroops(t){return {INF:t.INF||0,ARC:t.ARC||0,CAV:t.CAV||0};}
function isAnyPositive(t){return ["INF","ARC","CAV"].some(k=> (t[k]||0)>0 );}

function log(msg){
  const d=document.createElement("div");
  d.textContent=msg;
  logEl.appendChild(d);
  logEl.scrollTop=logEl.scrollHeight;
}

function incomeOf(owner){return cities.filter(c=>c.owner===owner).reduce((s,c)=>s+c.income,0);}
function heroName(id){return id? heroes[id]?.name || "??" : "ì—†ìŒ";}

function updateTop(){
  document.getElementById("turn").textContent=turn;
  document.getElementById("gold").textContent=gold;
  document.getElementById("income").textContent=incomeOf(PLAYER);
}

function citySummary(c){
  return `ã€${c.name}ã€‘ ${c.owner===PLAYER?'í”Œë ˆì´ì–´':c.owner===ENEMY?'ì ':'ì¤‘ë¦½'} | ë³‘ë ¥:${sumTroops(c.troops)} | ë°©ì–´:${c.defense} | ìˆ˜ì…:${c.income} | ì˜ì›…:${heroName(c.heroId)}`;
}

function refreshInfo(){
  const info=document.getElementById("cityInfo");
  const selectedInfo=document.getElementById("selectedInfo");
  
  if(!selectedId){
    info.textContent="ê±°ì ì„ í„°ì¹˜í•˜ì„¸ìš”.";
    selectedInfo.style.display="none";
    return;
  }
  
  const summary = citySummary(byId(selectedId));
  info.textContent = summary;
  
  // ëª¨ë°”ì¼ì—ì„œëŠ” ë– ìˆëŠ” ì¹´ë“œë¡œ í‘œì‹œ
  if(window.innerWidth < 768) {
    selectedInfo.innerHTML = summary;
    selectedInfo.style.display = "block";
    setTimeout(() => {
      selectedInfo.style.display = "none";
    }, 3000);
  }
}

/* ===== ìº”ë²„ìŠ¤ ë Œë”ë§ (ìŠ¤í¬ë¡¤ë§ ëŒ€ì‘) ===== */
const canvas=document.getElementById("map");
const ctx=canvas.getContext("2d");
const NODE_R=28;
const HIT_R2=(NODE_R+8)*(NODE_R+8);

function draw(){
  ctx.clearRect(0, 0, canvas.width / (window.devicePixelRatio || 1) / mapScale, canvas.height / (window.devicePixelRatio || 1) / mapScale);
  
  // ì—°ê²°ì„ 
  ctx.lineWidth=2;
  cities.forEach(c=>{
    c.adj.forEach(a=>{
      const t=byId(a);
      ctx.strokeStyle="#2b384a";
      ctx.beginPath();
      ctx.moveTo(c.x,c.y);
      ctx.lineTo(t.x,t.y);
      ctx.stroke();
    });
  });
  
  // ì´ë™ ì ì„ 
  movements.forEach(m=>{
    const s=byId(m.from),t=byId(m.to);
    ctx.setLineDash([8,8]);
    ctx.strokeStyle="#b7c7ff";
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(s.x,s.y);
    ctx.lineTo(t.x,t.y);
    ctx.stroke();
    ctx.setLineDash([]);
  });
  
  // ë…¸ë“œ
  cities.forEach(c=>{
    ctx.beginPath();
    ctx.arc(c.x,c.y,NODE_R,0,Math.PI*2);
    ctx.fillStyle=c.owner===PLAYER?"#2fb36b":c.owner===ENEMY?"#d94a4a":"#6e7a89";
    ctx.fill();
    ctx.lineWidth=2;
    ctx.strokeStyle="#0b0e12";
    ctx.stroke();
    
    if(c.id===selectedId){
      ctx.beginPath();
      ctx.arc(c.x,c.y,NODE_R+6,0,Math.PI*2);
      ctx.strokeStyle="#ffd76b";
      ctx.lineWidth=3;
      ctx.stroke();
    }
    
    // í…ìŠ¤íŠ¸ í¬ê¸°ë¥¼ ìŠ¤ì¼€ì¼ì— ë§ê²Œ ì¡°ì •
    const fontSize = Math.max(10, 14 * mapScale);
    const smallFont = Math.max(8, 12 * mapScale);
    
    if(c.defense>0){
      ctx.fillStyle="#ffde6b";
      ctx.font=`${fontSize}px sans-serif`;
      ctx.textAlign="center";
      ctx.fillText("ğŸ›¡"+c.defense, c.x, c.y+NODE_R+20);
    }
    
    if(c.heroId){
      ctx.fillStyle="#ffd27f";
      ctx.font=`${smallFont}px sans-serif`;
      ctx.textAlign="center";
      ctx.fillText("â˜…"+heroName(c.heroId), c.x, c.y+NODE_R+36);
    }
    
    ctx.fillStyle="#eaeaea";
    ctx.font=`${fontSize}px sans-serif`;
    ctx.textAlign="center";
    ctx.fillText(c.name, c.x, c.y-(NODE_R+10));
    ctx.fillText(`å…µ:${sumTroops(c.troops)}`, c.x, c.y+4);
  });
}

function cityAt(x,y){
  return cities.find(c=>{
    const dx=x-c.x,dy=y-c.y;
    return dx*dx+dy*dy<=HIT_R2;
  })?.id||null;
}

/* ===== í„°ì¹˜/í´ë¦­ í•¸ë“¤ë§ (ìŠ¤í¬ë¡¤ë§ ëŒ€ì‘) ===== */
function pickCityFromEvent(e){
  const container = document.getElementById('mapContainer');
  const canvas = document.getElementById('map');
  const rect = canvas.getBoundingClientRect();
  
  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;

  // ìŠ¤í¬ë¡¤ ì˜¤í”„ì…‹ ê³ ë ¤
  const scrollLeft = container.scrollLeft;
  const scrollTop = container.scrollTop;
  
  // ìº”ë²„ìŠ¤ ì¢Œí‘œë¡œ ë³€í™˜
  const x = ((clientX - rect.left + scrollLeft) / mapScale);
  const y = ((clientY - rect.top + scrollTop) / mapScale);

  return cityAt(x, y);
}

// í„°ì¹˜ ë“œë˜ê·¸ì™€ íƒ­ êµ¬ë¶„ì„ ìœ„í•œ ë³€ìˆ˜ë“¤
let touchStartX = 0;
let touchStartY = 0;
let touchMoved = false;
let touchStartTime = 0;

canvas.addEventListener("click",(e)=>{
  const hit=pickCityFromEvent(e);
  if(!hit) return;
  handleCitySelect(hit);
});

canvas.addEventListener("touchstart",(e)=>{
  e.preventDefault();
  
  touchStartX = e.touches[0].clientX;
  touchStartY = e.touches[0].clientY;
  touchStartTime = Date.now();
  touchMoved = false;
},{passive:false});

canvas.addEventListener("touchmove",(e)=>{
  e.preventDefault();
  
  const moveX = Math.abs(e.touches[0].clientX - touchStartX);
  const moveY = Math.abs(e.touches[0].clientY - touchStartY);
  
  if (moveX > 10 || moveY > 10) {
    touchMoved = true;
  }
},{passive:false});

canvas.addEventListener("touchend",(e)=>{
  e.preventDefault();
  
  const touchDuration = Date.now() - touchStartTime;
  
  // ì§§ì€ ì‹œê°„ ë™ì•ˆ ì›€ì§ì„ì´ ì ìœ¼ë©´ íƒ­ìœ¼ë¡œ ì²˜ë¦¬
  if (!touchMoved && touchDuration < 300) {
    // í„°ì¹˜ ì¢…ë£Œ ì‹œì ì˜ ì¢Œí‘œë¥¼ ì‚¬ìš©
    const touch = e.changedTouches[0];
    const fakeEvent = {
      touches: [touch],
      clientX: touch.clientX,
      clientY: touch.clientY
    };
    
    const hit = pickCityFromEvent(fakeEvent);
    if (hit) {
      vibrate([30]);
      handleCitySelect(hit);
    }
  }
},{passive:false});

function handleCitySelect(hit){
  selectedId=hit;
  refreshInfo();
  setButtons();
  draw();

  if(mode==="movePick" && moveFrom){
    if(moveFrom===hit) return;
    const from=byId(moveFrom), to=byId(hit);
    if(!from.adj.includes(to.id)){
      log("ì¸ì ‘ ê±°ì ë§Œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      vibrate([100,50,100]); // ì—ëŸ¬ ì§„ë™
      return;
    }
    if(from.owner!==PLAYER){
      log("ì•„êµ° ê±°ì ì—ì„œë§Œ ì´ë™ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      vibrate([100,50,100]);
      return;
    }
    if(sumTroops(from.troops)<=0){
      log("ë³‘ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.");
      vibrate([100,50,100]);
      return;
    }

    const heroChk = from.heroId ? 
      `<label><input type="checkbox" id="chkHero" ${heroes[from.heroId].inTransit?'disabled':''}> ì˜ì›… ë™í–‰ (${heroName(from.heroId)})</label>` : 
      `<span class="muted">ì˜ì›… ì—†ìŒ</span>`;
    
    mode="idle";
    document.getElementById("cmdArea").innerHTML=`
      <div class="panel">
        <h3>${from.name} â†’ ${to.name}</h3>
        <div class="row">
          <label>ë³´ë³‘<input type="number" id="mvINF" min="0" max="${from.troops.INF}" value="${Math.min(from.troops.INF, Math.floor(from.troops.INF/2))}"></label>
          <label>ê¶ìˆ˜<input type="number" id="mvARC" min="0" max="${from.troops.ARC}" value="${Math.min(from.troops.ARC, Math.floor(from.troops.ARC/2))}"></label>
          <label>ê¸°ë³‘<input type="number" id="mvCAV" min="0" max="${from.troops.CAV}" value="${Math.min(from.troops.CAV, Math.floor(from.troops.CAV/2))}"></label>
        </div>
        <div style="margin:8px 0">${heroChk}</div>
        <button id="doMove" class="full touch-feedback">ì´ë™ ì‹¤í–‰</button>
      </div>
    `;
    
    addTouchFeedback(document.getElementById("doMove"));
    document.getElementById("doMove").onclick=()=>{
      const INF=+document.getElementById("mvINF").value||0;
      const ARC=+document.getElementById("mvARC").value||0;
      const CAV=+document.getElementById("mvCAV").value||0;
      const withHero = from.heroId && !heroes[from.heroId].inTransit && (document.getElementById("chkHero")?.checked||false);
      
      if(INF>from.troops.INF||ARC>from.troops.ARC||CAV>from.troops.CAV){
        log("ë³‘ë ¥ ì´ˆê³¼ ì…ë ¥ì…ë‹ˆë‹¤.");
        vibrate([100,50,100]);
        return;
      }
      if(INF+ARC+CAV<=0 && !withHero){
        log("ì´ë™ ë³‘ë ¥ ë˜ëŠ” ì˜ì›… ë™í–‰ì„ ì„ íƒí•˜ì„¸ìš”.");
        vibrate([100,50,100]);
        return;
      }
      
      from.troops.INF-=INF; from.troops.ARC-=ARC; from.troops.CAV-=CAV;
      const mv={from:from.id,to:to.id,owner:from.owner,troops:{INF,ARC,CAV},heroId:withHero?from.heroId:null,turnsLeft:1};
      if(withHero){heroes[from.heroId].inTransit=true; from.heroId=null;}
      movements.push(mv);
      log(`í–‰êµ°: ${from.name} â†’ ${to.name} (ë³´${INF} ê¶${ARC} ê¸°${CAV}${withHero?`, ì˜ì›… ë™í–‰`:``})`);
      document.getElementById("cmdArea").innerHTML="";
      draw(); refreshInfo(); setButtons();
      vibrate([50,30,50]); // ì„±ê³µ ì§„ë™
    };
    moveFrom=null;
  }
}

/* ===== ëª…ë ¹ ë²„íŠ¼ë“¤ ===== */
const btnMove=document.getElementById("btnMove");
const btnRecruit=document.getElementById("btnRecruit");
const btnFortify=document.getElementById("btnFortify");
const btnCancel=document.getElementById("btnCancel");
const btnEndTurn=document.getElementById("btnEndTurn");
const cmdArea=document.getElementById("cmdArea");

function setButtons(){
  const sel=selectedId?byId(selectedId):null;
  btnMove.disabled=!(sel && sel.owner===PLAYER && sumTroops(sel.troops)>0);
  btnRecruit.disabled=!(sel && sel.owner===PLAYER);
  btnFortify.disabled=!(sel && sel.owner===PLAYER && sel.defense<5 && gold>=10);
  btnCancel.disabled=(mode==="idle");
}

btnMove.onclick=()=>{
  if(!selectedId) return;
  mode="movePick";
  moveFrom=selectedId;
  cmdArea.innerHTML=`<div class="panel"><div class="kv">ì´ë™ ëŒ€ìƒ ê±°ì ì„ í„°ì¹˜í•˜ì„¸ìš”. (ì¸ì ‘ë§Œ)</div></div>`;
  setButtons();
  vibrate([30]);
};

btnRecruit.onclick=()=>{
  if(!selectedId) return;
  mode="recruit";
  const c=byId(selectedId);
  cmdArea.innerHTML=`
    <div class="panel">
      <h3>ëª¨ì§‘ (ë³´1G/ê¶2G/ê¸°3G)</h3>
      <div class="row">
        <label>ë³´ë³‘<input type="number" id="rcINF" min="0" value="0"></label>
        <label>ê¶ìˆ˜<input type="number" id="rcARC" min="0" value="0"></label>
        <label>ê¸°ë³‘<input type="number" id="rcCAV" min="0" value="0"></label>
      </div>
      <button id="doRecruit" class="full touch-feedback">ëª¨ì§‘ í™•ì •</button>
    </div>
  `;
  
  addTouchFeedback(document.getElementById("doRecruit"));
  document.getElementById("doRecruit").onclick=()=>{
    const INF=+document.getElementById("rcINF").value||0;
    const ARC=+document.getElementById("rcARC").value||0;
    const CAV=+document.getElementById("rcCAV").value||0;
    const cost=INF*TRAIN_COST.INF + ARC*TRAIN_COST.ARC + CAV*TRAIN_COST.CAV;
    
    if(cost>gold){
      log(`ê¸ˆ ë¶€ì¡±: í•„ìš” ${cost}G / ë³´ìœ  ${gold}G`);
      vibrate([100,50,100]);
      return;
    }
    
    c.troops.INF+=INF; c.troops.ARC+=ARC; c.troops.CAV+=CAV; gold-=cost;
    log(`ã€${c.name}ã€‘ ëª¨ì§‘: ë³´${INF} ê¶${ARC} ê¸°${CAV} (âˆ’${cost}G)`);
    mode="idle";
    cmdArea.innerHTML="";
    updateTop(); refreshInfo(); draw(); setButtons();
    vibrate([50,30,50]);
  };
  setButtons();
  vibrate([30]);
};

btnFortify.onclick=()=>{
  if(!selectedId) return;
  const c=byId(selectedId);
  if(c.defense>=5 || gold<10) return;
  
  c.defense+=1; gold-=10;
  log(`ã€${c.name}ã€‘ ìš”ìƒˆí™” +1 (ë°©ì–´ ${c.defense}, ê¸ˆ ${gold})`);
  refreshInfo(); updateTop(); draw(); setButtons();
  vibrate([50,30,50]);
};

btnCancel.onclick=()=>{
  mode="idle";
  moveFrom=null;
  cmdArea.innerHTML="";
  setButtons();
  vibrate([30]);
};

btnEndTurn.onclick=endTurn;

/* ===== ì „íˆ¬ ì‹œìŠ¤í…œ ===== */
const battleOverlay=document.getElementById("battleOverlay");
const battleHeader=document.getElementById("battleHeader");
const eAttHeroName=document.getElementById("attHeroName");
const eDefHeroName=document.getElementById("defHeroName");
const barAtt=document.getElementById("barAtt");
const barDef=document.getElementById("barDef");
const attPctTxt=document.getElementById("attPctTxt");
const defPctTxt=document.getElementById("defPctTxt");
const battleLog=document.getElementById("battleLog");
const btnBattleRound=document.getElementById("btnBattleRound");
const btnBattleAuto=document.getElementById("btnBattleAuto");
const btnBattleRetreat=document.getElementById("btnBattleRetreat");
const btnBattleFinish=document.getElementById("btnBattleFinish");

let battleState=null;

function openBattle({attFrom, attOwner, toId, att, heroId}){
  const dest=byId(toId);
  const def=cloneTroops(dest.troops);

  const attMax=Math.max(1,sumTroops(att));
  const defMax=Math.max(1,Math.floor(sumTroops(def)*(1+dest.defense*0.15)));

  battleState={
    attFrom, attOwner, toId,
    att: cloneTroops(att),
    def,
    defense: dest.defense,
    attHeroId: heroId || null,
    defHeroId: dest.heroId || null,
    finished:false, retreated:false,
    attMax, defMax
  };
  
  battleLog.innerHTML="";
  battleHeader.textContent=`ê³µê²©: ${byId(attFrom).name} (${attOwner}) â†’ ë°©ì–´: ${dest.name} (${dest.owner})`;
  eAttHeroName.textContent = heroName(battleState.attHeroId);
  eDefHeroName.textContent = heroName(battleState.defHeroId);
  syncBattleBars();
  battleOverlay.style.display="flex";
  vibrate([100,50,100,50]); // ì „íˆ¬ ì‹œì‘ ì§„ë™
}

function sum(t){return (t.INF|0)+(t.ARC|0)+(t.CAV|0);}

function getHeroBuff(side, enemyTroops){
  const id = side==='att'? battleState.attHeroId : battleState.defHeroId;
  if(!id) return {atkMul:1, defMul:1, morale:0};
  const h=heroes[id]; const aura=h.aura||{}; const adv=h.advantage||{};
  const total=sum(enemyTroops); let advBonus=0;
  if(total>0){ 
    ["INF","ARC","CAV"].forEach(tp=>{ 
      const portion=(enemyTroops[tp]||0)/total; 
      advBonus += (adv[tp]||0)*portion; 
    }); 
  }
  return { 
    atkMul:1+(aura.atkPct||0)+advBonus, 
    defMul:1+(aura.defPct||0), 
    morale:h.moraleBoost||0 
  };
}

function syncBattleBars(){
  const s=battleState; if(!s) return;
  const attNow=sum(s.att), defNow=sum(s.def);
  const attPct=Math.max(0,Math.min(100,Math.round((attNow/s.attMax)*100)));
  const defPct=Math.max(0,Math.min(100,Math.round(((defNow*(1+s.defense*0.15))/s.defMax)*100)));
  barAtt.style.width=attPct+"%";
  barDef.style.width=defPct+"%";
  attPctTxt.textContent=attPct+"%";
  defPctTxt.textContent=defPct+"%";
  btnBattleFinish.disabled=!s.finished;
}

function battleRoundOnce(){
  const s=battleState; if(!s || s.finished) return;
  const rand=(a,b)=> a + Math.random()*(b-a);
  const attBuff=getHeroBuff('att', s.def);
  const defBuff=getHeroBuff('def', s.att);

  let defLoss={INF:0,ARC:0,CAV:0}, attLoss={INF:0,ARC:0,CAV:0};

  // ê³µê²© â†’ ìˆ˜ë¹„
  TYPES.forEach(aType=>{
    const base=s.att[aType]; if(base<=0) return;
    TYPES.forEach(dType=>{
      const mult=COUNTER[aType][dType];
      const power=Math.floor( base * rand(0.18,0.26) * mult * attBuff.atkMul * (1 + attBuff.morale/100) );
      defLoss[dType]+=power;
    });
  });

  // ìˆ˜ë¹„ â†’ ê³µê²©
  TYPES.forEach(dType=>{
    const base=s.def[dType]; if(base<=0) return;
    TYPES.forEach(aType=>{
      const mult=COUNTER[dType][aType];
      const power=Math.floor( base * rand(0.12,0.20) * mult * defBuff.defMul * (1 + defBuff.morale/100) * (1 + s.defense*0.08) );
      attLoss[aType]+=power;
    });
  });

  // ìˆ˜ë¹„ í”¼í•´ ê°ì†Œ
  TYPES.forEach(t=>{ 
    defLoss[t]=Math.max(0, Math.floor(defLoss[t] * (1 - Math.min(0.45, s.defense*0.07)))); 
  });

  // ì ìš©
  TYPES.forEach(t=>{ 
    s.def[t]=Math.max(0,s.def[t]-defLoss[t]); 
    s.att[t]=Math.max(0,s.att[t]-attLoss[t]); 
  });

  const line=`ë¼ìš´ë“œ â–¶ ìˆ˜ë¹„í”¼í•´: -${defLoss.INF+defLoss.ARC+defLoss.CAV} / ê³µê²©í”¼í•´: -${attLoss.INF+attLoss.ARC+attLoss.CAV}`;
  const d=document.createElement("div"); 
  d.textContent=line; 
  battleLog.appendChild(d); 
  battleLog.scrollTop=battleLog.scrollHeight;

  if(!isAnyPositive(s.att) || !isAnyPositive(s.def)){ 
    s.finished=true; 
    vibrate([200]); // ì „íˆ¬ ì¢…ë£Œ ì§„ë™
  } else {
    vibrate([30]); // ë¼ìš´ë“œ ì§„ë™
  }
  syncBattleBars();
}

// ì „íˆ¬ ë²„íŠ¼ë“¤ì— í„°ì¹˜ í”¼ë“œë°± ì¶”ê°€
addTouchFeedback(btnBattleRound);
addTouchFeedback(btnBattleAuto);
addTouchFeedback(btnBattleRetreat);
addTouchFeedback(btnBattleFinish);

btnBattleRound.onclick=battleRoundOnce;

btnBattleAuto.onclick=()=>{
  let g=0;
  const autoInterval = setInterval(() => {
    if(!battleState || battleState.finished || g>=64) {
      clearInterval(autoInterval);
      return;
    }
    battleRoundOnce();
    g++;
  }, 500); // 0.5ì´ˆ ê°„ê²©ìœ¼ë¡œ ìë™ ì „íˆ¬
};

btnBattleRetreat.onclick=()=>{
  if(!battleState||battleState.finished)return;
  battleState.retreated=true;
  battleState.finished=true;
  const d=document.createElement("div");
  d.innerHTML="<b>í‡´ê°!</b>";
  battleLog.appendChild(d);
  battleLog.scrollTop=battleLog.scrollHeight;
  syncBattleBars();
  vibrate([100,50,100]);
};

btnBattleFinish.onclick=()=>{
  const s=battleState; if(!s||!s.finished)return; 
  const dest=byId(s.toId);
  
  if(s.retreated){
    if(isAnyPositive(s.att)){ 
      addTroops(byId(s.attFrom).troops, s.att); 
      log(`í‡´ê°: ${byId(s.attFrom).name} ê·€í™˜`); 
    }
    if(s.attHeroId){ 
      byId(s.attFrom).heroId=s.attHeroId; 
      heroes[s.attHeroId].inTransit=false; 
      log(`ì˜ì›… ${heroName(s.attHeroId)} í‡´ê° ë³µê·€`); 
    }
  }else{
    const attSum=sum(s.att), defSum=sum(s.def);
    if(defSum<=0 && attSum>0){
      if(s.defHeroId){ 
        log(`ìˆ˜ë¹„ ì˜ì›… ${heroName(s.defHeroId)} ë„ì£¼`); 
      }
      dest.owner=s.attOwner; 
      dest.troops=cloneTroops(s.att); 
      dest.defense=Math.max(0,dest.defense-1);
      dest.heroId=s.attHeroId||null; 
      if(s.attHeroId){ 
        heroes[s.attHeroId].inTransit=false; 
      }
      log(`í•¨ë½! ${dest.name} ì ë ¹${s.attHeroId?` (ì˜ì›… ${heroName(s.attHeroId)} ë¶€ì„)`:""}`);
      vibrate([200,100,200]); // ìŠ¹ë¦¬ ì§„ë™
    }else{
      dest.troops=cloneTroops(s.def);
      if(attSum>0){ 
        addTroops(byId(s.attFrom).troops, s.att); 
        log(`ê³µê²© ì‹¤íŒ¨, ${byId(s.attFrom).name} ê·€í™˜`); 
      }
      if(s.attHeroId){ 
        byId(s.attFrom).heroId=s.attHeroId; 
        heroes[s.attHeroId].inTransit=false; 
        log(`ì˜ì›… ${heroName(s.attHeroId)} ê³µê²© ì‹¤íŒ¨ ë³µê·€`); 
      }
      log(`ë°©ì–´ ì„±ê³µ: ${dest.name}`);
    }
  }
  
  battleOverlay.style.display="none"; 
  battleState=null; 
  draw(); 
  refreshInfo(); 
  updateTop();
};

/* ===== ì´ë™/ì „íˆ¬ ì²˜ë¦¬ ===== */
function resolveMovementsOrOpenBattles(){
  const idx=movements.findIndex(m=>m.turnsLeft<=0);
  if(idx===-1) return false;
  
  const m=movements[idx], dest=byId(m.to);
  if(dest.owner===m.owner){
    addTroops(dest.troops, m.troops);
    if(m.heroId){ 
      dest.heroId=m.heroId; 
      heroes[m.heroId].inTransit=false; 
      log(`ì˜ì›… ${heroName(m.heroId)} ${dest.name} ë¶€ì„`); 
    }
    log(`í•©ë¥˜: ${dest.name}`);
    movements.splice(idx,1); 
    return true;
  }else{
    openBattle({
      attFrom:m.from, 
      attOwner:m.owner, 
      toId:m.to, 
      att:m.troops, 
      heroId:m.heroId||null
    });
    movements.splice(idx,1); 
    return true;
  }
}

function resolveMovementsStepwise(){
  for(let i=0;i<movements.length;i++){
    movements[i].turnsLeft--;
  }
  while(true){
    const progressed=resolveMovementsOrOpenBattles();
    if(!progressed) break;
    if(battleState) break;
  }
}

/* ===== AI ===== */
function aiPhase(){
  const aiCities=cities.filter(c=>c.owner===ENEMY && sumTroops(c.troops)>=12);
  for(const from of aiCities){
    const targets=from.adj.map(id=>byId(id)).filter(t=>t.owner!==ENEMY);
    if(targets.length===0) continue;
    
    targets.sort((a,b)=>(sumTroops(a.troops)+a.defense*2)-(sumTroops(b.troops)+b.defense*2));
    const to=targets[0];
    const send=cloneTroops({
      INF:Math.floor(from.troops.INF/2),
      ARC:Math.floor(from.troops.ARC/2),
      CAV:Math.floor(from.troops.CAV/2)
    });
    
    if(sumTroops(send)>0){
      subTroops(from.troops, send);
      let heroId=null;
      if(from.heroId && !heroes[from.heroId].inTransit && Math.random()<0.5){ 
        heroId=from.heroId; 
        from.heroId=null; 
        heroes[heroId].inTransit=true; 
      }
      movements.push({
        from:from.id,
        to:to.id,
        owner:ENEMY,
        troops:send,
        heroId,
        turnsLeft:1
      });
      log(`(AI) í–‰êµ°: ${from.name} â†’ ${to.name}${heroId?` (ì˜ì›… ë™í–‰)`:``}`);
    }
  }
}

/* ===== í„´ ì¢…ë£Œ ===== */
function endTurn(){
  gold+=incomeOf(PLAYER);
  resolveMovementsStepwise(); 
  if(battleState){ 
    updateTop(); 
    draw(); 
    refreshInfo(); 
    return; 
  }
  
  aiPhase();
  resolveMovementsStepwise(); 
  if(battleState){ 
    updateTop(); 
    draw(); 
    refreshInfo(); 
    return; 
  }
  
  turn++;
  updateTop(); 
  draw(); 
  refreshInfo();
  vibrate([50]); // í„´ ì¢…ë£Œ í”¼ë“œë°±
}

/* ===== ì´ˆê¸°í™” (ìŠ¤í¬ë¡¤ë§ í¬í•¨) ===== */
function bootstrap(){
  // ë§µ í¬ê¸° ì´ˆê¸°í™”
  initMapDimensions();
  
  updateTop(); 
  refreshInfo(); 
  draw(); 
  log("ê²Œì„ ì‹œì‘. í”Œë ˆì´ì–´ì˜ í„´ì…ë‹ˆë‹¤.");
  
  // í„°ì¹˜ í”¼ë“œë°± ì¶”ê°€
  document.querySelectorAll('.touch-feedback').forEach(addTouchFeedback);
  
  // íƒ­ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
  initTabs();
  
  // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  const container = document.getElementById('mapContainer');
  container.addEventListener('scroll', updateScrollIndicators, {passive: true});
  
  // ì´ˆê¸° ìŠ¤í¬ë¡¤ ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸
  setTimeout(updateScrollIndicators, 100);
}

function fixHiDPI(){
  initMapDimensions();
  draw();
}

// ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
function handleResize() {
  clearTimeout(window.resizeTimeout);
  window.resizeTimeout = setTimeout(() => {
    initMapDimensions();
    draw();
    updateScrollIndicators();
  }, 100);
}

window.addEventListener('resize', handleResize);
window.addEventListener('orientationchange', () => {
  setTimeout(() => {
    initMapDimensions();
    draw();
    updateScrollIndicators();
    // ë°©í–¥ ì „í™˜ í›„ ë‹¤ì‹œ í”Œë ˆì´ì–´ ì¤‘ì‹¬ìœ¼ë¡œ
    setTimeout(centerMapOnPlayer, 200);
  }, 100);
});

// ê²Œì„ ì‹œì‘
bootstrap();

</script>
</body>
</html>
