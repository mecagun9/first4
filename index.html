<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>ì‚¼êµ­ì§€3 ìŠ¤íƒ€ì¼ í„´ì œ + ì „íˆ¬ í™”ë©´ + ë³‘ì¢…/ë¹„ìš©</title>
<style>
  body{margin:0;background:#1a1d24;color:#eaeaea;font-family:system-ui,apple-system,sans-serif}
  #wrap{display:flex;gap:12px;padding:12px}
  #left{flex:0 0 760px}
  #right{flex:1;display:flex;flex-direction:column;gap:8px}
  canvas{background:#0f1115;border:1px solid #333;border-radius:8px;display:block}
  .panel{background:#12151c;border:1px solid #2a2e38;border-radius:8px;padding:10px}
  h3{margin:0 0 8px 0;font-size:14px;color:#8bd0ff}
  button{background:#2a3242;border:1px solid #445169;color:#eaeaea;border-radius:6px;padding:8px 10px;cursor:pointer}
  button:disabled{opacity:.5;cursor:not-allowed}
  .row{display:flex;gap:6px;flex-wrap:wrap}
  .kv{font-size:12px;opacity:.9}
  input[type=number]{width:72px;background:#0f1115;color:#fff;border:1px solid #2a2e38;border-radius:6px;padding:6px}
  small{opacity:.8}
  .muted{opacity:.7}
  /* ì „íˆ¬ ì˜¤ë²„ë ˆì´ */
  #battleOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.65);z-index:9999}
  #battleBox{width:820px;background:#0f1115;border:1px solid #2a2e38;border-radius:10px;padding:16px}
  #battleLog{height:160px;overflow:auto;background:#11151d;border:1px solid #2a2e38;border-radius:8px;padding:8px;font-size:12px}
  .cols{display:flex;gap:12px}
  .col{flex:1}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{border:1px solid #2a2e38;padding:4px;text-align:center}
</style>
</head>
<body>
<div id="wrap">
  <div id="left"><canvas id="map" width="760" height="600"></canvas></div>
  <div id="right">
    <div class="panel">
      <h3>í„´ / ìì›</h3>
      <div class="kv">í˜„ì¬ í„´: <b id="turn">1</b></div>
      <div class="kv">ê¸ˆ: <b id="gold">200</b> G</div>
      <div class="kv">ìˆ˜ì…(í„´ë‹¹): <b id="income">0</b> G</div>
      <div class="kv muted">ëª¨ì§‘ ë¹„ìš©: ë³´ë³‘ 1G / ê¶ìˆ˜ 2G / ê¸°ë³‘ 3G</div>
    </div>

    <div class="panel">
      <h3>ê±°ì  ì •ë³´</h3>
      <div id="cityInfo" class="kv">ê±°ì ì„ í´ë¦­í•˜ì„¸ìš”.</div>
    </div>

    <div class="panel">
      <h3>ëª…ë ¹</h3>
      <div class="row">
        <button id="btnMove" disabled>ì´ë™</button>
        <button id="btnRecruit" disabled>ëª¨ì§‘</button>
        <button id="btnFortify" disabled>ìš”ìƒˆí™”</button>
        <button id="btnCancel" disabled>ì·¨ì†Œ</button>
      </div>
      <div id="cmdArea" style="margin-top:8px;"></div>
      <div style="margin-top:8px"><button id="btnEnd">í„´ ì¢…ë£Œ â–¶</button></div>
      <small>â€¢ ì´ë™: ì¸ì ‘ ê±°ì ë§Œ, 1í„´ ì†Œìš” â†’ ì /ì¤‘ë¦½ ë„ì°© ì‹œ ì „íˆ¬ í™”ë©´<br>â€¢ ëª¨ì§‘: ë¹„ìš© ë³‘ì¢…ë³„ ìƒì´(ìƒë‹¨ ì°¸ê³ )<br>â€¢ ìš”ìƒˆí™”: 10Gë¡œ ë°©ì–´ +1 (ìµœëŒ€ +5)</small>
    </div>

    <div class="panel">
      <h3>ë¡œê·¸</h3>
      <div id="log" style="height:200px;overflow:auto;font-size:12px;line-height:1.4"></div>
    </div>
  </div>
</div>

<!-- ì „íˆ¬ ì˜¤ë²„ë ˆì´ -->
<div id="battleOverlay">
  <div id="battleBox">
    <h3>ì „íˆ¬</h3>
    <div id="battleHeader" class="kv">ê³µê²©: ? â†’ ë°©ì–´: ?</div>

    <div class="cols" style="margin:10px 0 6px 0">
      <div class="col">
        <table>
          <thead><tr><th colspan="3">ê³µê²© ë³‘ë ¥</th></tr></thead>
          <tbody>
            <tr><td>ë³´ë³‘</td><td>ê¶ìˆ˜</td><td>ê¸°ë³‘</td></tr>
            <tr><td id="attINF">0</td><td id="attARC">0</td><td id="attCAV">0</td></tr>
          </tbody>
        </table>
      </div>
      <div class="col">
        <table>
          <thead><tr><th colspan="3">ìˆ˜ë¹„ ë³‘ë ¥</th></tr></thead>
          <tbody>
            <tr><td>ë³´ë³‘</td><td>ê¶ìˆ˜</td><td>ê¸°ë³‘</td></tr>
            <tr><td id="defINF">0</td><td id="defARC">0</td><td id="defCAV">0</td></tr>
          </tbody>
        </table>
        <div class="kv" style="margin-top:6px">ë°©ì–´: <b id="defDefense">0</b></div>
      </div>
    </div>

    <div class="row" style="margin-bottom:8px">
      <button id="btnBattleRound">ë‹¤ìŒ ë¼ìš´ë“œ</button>
      <button id="btnBattleAuto">ìë™ ì „íˆ¬</button>
      <button id="btnBattleRetreat">ê³µê²© ì¤‘ì§€(í‡´ê°)</button>
      <button id="btnBattleFinish" disabled>ì „íˆ¬ ì¢…ë£Œ(ê²°ê³¼ ë°˜ì˜)</button>
    </div>

    <div id="battleLog"></div>
  </div>
</div>

<script>
/* ===== ë³‘ì¢…/ë¹„ìš©/ìƒì„± ===== */
const TYPES = ["INF","ARC","CAV"]; // ë³´ë³‘, ê¶ìˆ˜, ê¸°ë³‘
const TYPE_NAME = {INF:"ë³´ë³‘", ARC:"ê¶ìˆ˜", CAV:"ê¸°ë³‘"};
const TRAIN_COST = {INF:1, ARC:2, CAV:3}; // ëª¨ì§‘ ë¹„ìš©(1ëª…ë‹¹)
const COUNTER = {
  // aê°€ bë¥¼ ìƒëŒ€í•  ë•Œì˜ ë³´ì •(ê³µê²© ë°°ìˆ˜)
  INF: { INF:1.0, ARC:1.25, CAV:0.85 },
  ARC: { INF:0.9, ARC:1.0,  CAV:1.25 },
  CAV: { INF:1.25,ARC:0.85, CAV:1.0  },
};

/* ===== ê¸°ë³¸ ìƒìˆ˜ ë° ìƒíƒœ ===== */
const PLAYER="player", ENEMY="enemy", NEUT="neutral";
const cities = [
  // troopsë¥¼ ë³‘ì¢…ë³„ë¡œ êµ¬ì„±
  {id:"JI", name:"ê³„(ê³„ì„±)", x:120, y:90,  owner:PLAYER, troops:{INF:30,ARC:6,CAV:4}, defense:1, income:12, adj:["YE","BO"]},
  {id:"YE", name:"ì—…",       x:210, y:120, owner:PLAYER, troops:{INF:20,ARC:6,CAV:4}, defense:1, income:10, adj:["JI","BO","PU"]},
  {id:"BO", name:"ë°•",       x:170, y:180, owner:NEUT,   troops:{INF:12,ARC:2,CAV:1}, defense:0, income:6,  adj:["JI","YE","PU","CH"]},
  {id:"PU", name:"ë¶€",       x:260, y:190, owner:ENEMY,  troops:{INF:20,ARC:6,CAV:4}, defense:1, income:9,  adj:["YE","BO","CH","LU"]},
  {id:"CH", name:"í—ˆ/ì°½",    x:220, y:250, owner:NEUT,   troops:{INF:8, ARC:1,CAV:1}, defense:0, income:6,  adj:["BO","PU","LU","RU"]},
  {id:"LU", name:"ë‚™ì–‘",     x:295, y:255, owner:ENEMY,  troops:{INF:18,ARC:4,CAV:3}, defense:1, income:9,  adj:["PU","CH","RU"]},
  {id:"RU", name:"ì—¬ë‚¨",     x:260, y:320, owner:NEUT,   troops:{INF:9, ARC:2,CAV:1}, defense:0, income:6,  adj:["CH","LU","SH"]},
  {id:"SH", name:"ìˆ˜ì¶˜",     x:310, y:380, owner:ENEMY,  troops:{INF:16,ARC:4,CAV:2}, defense:1, income:8,  adj:["RU","GU"]},
  {id:"GU", name:"ê´‘ë¦‰",     x:360, y:330, owner:NEUT,   troops:{INF:8, ARC:1,CAV:1}, defense:0, income:6,  adj:["SH","QH"]},
  {id:"QH", name:"ê±´ì—…",     x:420, y:360, owner:ENEMY,  troops:{INF:18,ARC:6,CAV:4}, defense:1, income:10, adj:["GU","HU"]},
  {id:"HU", name:"íšŒê³„",     x:520, y:390, owner:NEUT,   troops:{INF:7, ARC:2,CAV:1}, defense:0, income:6,  adj:["QH"]},
  {id:"PI", name:"ë¶í‰",     x:140, y:40,  owner:NEUT,   troops:{INF:6, ARC:1,CAV:1}, defense:0, income:5,  adj:["JI"]},
];
let turn=1, gold=200;
let movements=[]; // {from,to,owner,troops:{INF,ARC,CAV},turnsLeft}
let selectedId=null, mode="idle", moveFrom=null;

const logEl=document.getElementById("log");
const byId=id=>cities.find(c=>c.id===id);
const sumTroops=t=>TYPES.reduce((s,k)=>s+(t[k]||0),0);
function addTroops(a,b){ TYPES.forEach(k=>a[k]=(a[k]||0)+(b[k]||0)); }
function subTroops(a,b){ TYPES.forEach(k=>a[k]=(a[k]||0)- (b[k]||0)); }
function cloneTroops(t){ return {INF:t.INF||0, ARC:t.ARC||0, CAV:t.CAV||0}; }
function isAnyPositive(t){ return TYPES.some(k=>(t[k]||0)>0); }

function log(msg){ const d=document.createElement("div"); d.textContent=msg; logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight; }
function incomeOf(owner){ return cities.filter(c=>c.owner===owner).reduce((s,c)=>s+c.income,0); }
function updateTop(){
  document.getElementById("turn").textContent=turn;
  document.getElementById("gold").textContent=gold;
  document.getElementById("income").textContent=incomeOf(PLAYER);
}
function citySummary(c){
  return `ã€${c.name}ã€‘ ${c.owner===PLAYER?'í”Œë ˆì´ì–´':c.owner===ENEMY?'ì ':'ì¤‘ë¦½'} | ë³‘ë ¥:${sumTroops(c.troops)} (ë³´:${c.troops.INF} ê¶:${c.troops.ARC} ê¸°:${c.troops.CAV}) | ë°©ì–´:${c.defense} | ìˆ˜ì…:${c.income}`;
}
function refreshInfo(){
  const info=document.getElementById("cityInfo");
  if(!selectedId){ info.textContent="ê±°ì ì„ í´ë¦­í•˜ì„¸ìš”."; return; }
  info.textContent=citySummary(byId(selectedId));
}

/* ===== ë§µ ë Œë”ë§ ===== */
const canvas=document.getElementById("map");
const ctx=canvas.getContext("2d");
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // ì—°ê²°ì„ 
  ctx.lineWidth=2;
  cities.forEach(c=>{
    c.adj.forEach(a=>{
      const t=byId(a);
      ctx.strokeStyle="#2c3647";
      ctx.beginPath(); ctx.moveTo(c.x,c.y); ctx.lineTo(t.x,t.y); ctx.stroke();
    });
  });
  // ì´ë™ ì ì„ 
  movements.forEach(m=>{
    const s=byId(m.from), t=byId(m.to);
    ctx.setLineDash([6,6]); ctx.strokeStyle="#bbb";
    ctx.beginPath(); ctx.moveTo(s.x,s.y); ctx.lineTo(t.x,t.y); ctx.stroke();
    ctx.setLineDash([]);
  });
  // ë…¸ë“œ
  cities.forEach(c=>{
    ctx.beginPath(); ctx.arc(c.x,c.y,18,0,Math.PI*2);
    ctx.fillStyle = c.owner===PLAYER?"#3aa76d":c.owner===ENEMY?"#d94a4a":"#777";
    ctx.fill(); ctx.lineWidth=2; ctx.strokeStyle="#0e0e0e"; ctx.stroke();
    if(c.id===selectedId){ ctx.beginPath(); ctx.arc(c.x,c.y,22,0,Math.PI*2); ctx.strokeStyle="#ffde6b"; ctx.lineWidth=2; ctx.stroke(); }
    if(c.defense>0){ ctx.fillStyle="#ffde6b"; ctx.font="12px sans-serif"; ctx.fillText("ğŸ›¡"+c.defense, c.x-12, c.y+30); }
    ctx.fillStyle="#eaeaea"; ctx.font="12px sans-serif"; ctx.textAlign="center";
    ctx.fillText(c.name, c.x, c.y-26);
    ctx.fillText(`å…µ:${sumTroops(c.troops)}`, c.x, c.y-10);
  });
}
function cityAt(x,y){
  return cities.find(c=>{ const dx=x-c.x, dy=y-c.y; return dx*dx+dy*dy<=18*18+8; })?.id||null;
}

/* ===== ëª…ë ¹ UI ===== */
const btnMove=document.getElementById("btnMove");
const btnRecruit=document.getElementById("btnRecruit");
const btnFortify=document.getElementById("btnFortify");
const btnCancel=document.getElementById("btnCancel");
const btnEnd=document.getElementById("btnEnd");
const cmdArea=document.getElementById("cmdArea");

function setButtons(){
  const sel=selectedId?byId(selectedId):null;
  btnMove.disabled=!(sel && sel.owner===PLAYER && sumTroops(sel.troops)>0);
  btnRecruit.disabled=!(sel && sel.owner===PLAYER);
  btnFortify.disabled=!(sel && sel.owner===PLAYER && sel.defense<5 && gold>=10);
  btnCancel.disabled=(mode==="idle");
}
btnMove.onclick=()=>{
  if(!selectedId) return;
  mode="movePick"; moveFrom=selectedId;
  cmdArea.innerHTML=`<div class="kv">ì´ë™ ëŒ€ìƒ ê±°ì ì„ í´ë¦­í•˜ì„¸ìš”. (ì¸ì ‘ë§Œ)</div>`;
  setButtons();
};
btnRecruit.onclick=()=>{
  if(!selectedId) return;
  mode="recruit";
  const c=byId(selectedId);
  cmdArea.innerHTML=`
    <div class="kv">ëª¨ì§‘ ìˆ˜ (ë¹„ìš©: ë³´1G/ê¶2G/ê¸°3G)</div>
    <div class="row">
      <div>ë³´ë³‘: <input type="number" id="rcINF" min="0" value="0"></div>
      <div>ê¶ìˆ˜: <input type="number" id="rcARC" min="0" value="0"></div>
      <div>ê¸°ë³‘: <input type="number" id="rcCAV" min="0" value="0"></div>
      <button id="doRecruit">í™•ì¸</button>
    </div>
  `;
  document.getElementById("doRecruit").onclick=()=>{
    const INF=+document.getElementById("rcINF").value||0;
    const ARC=+document.getElementById("rcARC").value||0;
    const CAV=+document.getElementById("rcCAV").value||0;
    const cost=INF*TRAIN_COST.INF + ARC*TRAIN_COST.ARC + CAV*TRAIN_COST.CAV;
    if(cost>gold){ log(`ê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤. í•„ìš”:${cost}G, ë³´ìœ :${gold}G`); return; }
    c.troops.INF+=INF; c.troops.ARC+=ARC; c.troops.CAV+=CAV;
    gold-=cost;
    log(`ã€${c.name}ã€‘ ëª¨ì§‘ ì™„ë£Œ: ë³´${INF} ê¶${ARC} ê¸°${CAV} (-${cost}G)`);
    mode="idle"; cmdArea.innerHTML=""; updateTop(); refreshInfo(); draw(); setButtons();
  };
  setButtons();
};
btnFortify.onclick=()=>{
  if(!selectedId) return;
  const c=byId(selectedId);
  if(c.defense>=5 || gold<10) return;
  c.defense+=1; gold-=10;
  log(`ã€${c.name}ã€‘ ìš”ìƒˆí™” +1 (ë°©ì–´ ${c.defense}, ê¸ˆ:${gold})`);
  refreshInfo(); updateTop(); draw(); setButtons();
};
btnCancel.onclick=()=>{ mode="idle"; moveFrom=null; cmdArea.innerHTML=""; setButtons(); };
btnEnd.onclick=endTurn;

/* ë§µ í´ë¦­ */
canvas.addEventListener("click",(e)=>{
  const rect=canvas.getBoundingClientRect();
  const x=e.clientX-rect.left, y=e.clientY-rect.top;
  const hit=cityAt(x,y); if(!hit) return;
  selectedId=hit; refreshInfo(); setButtons(); draw();

  if(mode==="movePick" && moveFrom){
    if(moveFrom===hit) return;
    const from=byId(moveFrom), to=byId(hit);
    if(!from.adj.includes(to.id)){ log("ì¸ì ‘ ê±°ì ë§Œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return; }
    if(from.owner!==PLAYER){ log("ì†Œìœ  ê±°ì ì—ì„œë§Œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return; }
    if(sumTroops(from.troops)<=0){ log("ë³‘ë ¥ì´ ì—†ìŠµë‹ˆë‹¤."); return; }

    // ë³‘ì¢…ë³„ ì´ë™ ì…ë ¥
    mode="idle";
    cmdArea.innerHTML=`
      <div class="kv">ì´ë™ ë³‘ë ¥ ì…ë ¥ (ìµœëŒ€: ë³´${from.troops.INF} ê¶${from.troops.ARC} ê¸°${from.troops.CAV})</div>
      <div class="row">
        <div>ë³´ë³‘: <input type="number" id="mvINF" min="0" max="${from.troops.INF}" value="${Math.min(from.troops.INF, Math.floor(from.troops.INF/2))}"></div>
        <div>ê¶ìˆ˜: <input type="number" id="mvARC" min="0" max="${from.troops.ARC}" value="${Math.min(from.troops.ARC, Math.floor(from.troops.ARC/2))}"></div>
        <div>ê¸°ë³‘: <input type="number" id="mvCAV" min="0" max="${from.troops.CAV}" value="${Math.min(from.troops.CAV, Math.floor(from.troops.CAV/2))}"></div>
        <button id="doMove">ì´ë™</button>
      </div>
    `;
    document.getElementById("doMove").onclick=()=>{
      const INF=+document.getElementById("mvINF").value||0;
      const ARC=+document.getElementById("mvARC").value||0;
      const CAV=+document.getElementById("mvCAV").value||0;
      if(INF>from.troops.INF||ARC>from.troops.ARC||CAV>from.troops.CAV){ log("ë³‘ë ¥ ì´ˆê³¼ ì…ë ¥ì…ë‹ˆë‹¤."); return; }
      if(INF+ARC+CAV<=0){ log("ì´ë™ ë³‘ë ¥ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
      from.troops.INF-=INF; from.troops.ARC-=ARC; from.troops.CAV-=CAV;
      movements.push({from:from.id,to:to.id,owner:from.owner,troops:{INF,ARC,CAV},turnsLeft:1});
      log(`í–‰êµ°: ${from.name} â†’ ${to.name} (ë³´${INF} ê¶${ARC} ê¸°${CAV})`);
      cmdArea.innerHTML=""; draw(); refreshInfo(); setButtons();
    };
    moveFrom=null;
  }
});

/* ===== ì „íˆ¬ ì˜¤ë²„ë ˆì´ ===== */
const battleOverlay=document.getElementById("battleOverlay");
const battleHeader=document.getElementById("battleHeader");
const eAttINF=document.getElementById("attINF"), eAttARC=document.getElementById("attARC"), eAttCAV=document.getElementById("attCAV");
const eDefINF=document.getElementById("defINF"), eDefARC=document.getElementById("defARC"), eDefCAV=document.getElementById("defCAV");
const eDefDefense=document.getElementById("defDefense");
const battleLog=document.getElementById("battleLog");
const btnBattleRound=document.getElementById("btnBattleRound");
const btnBattleAuto=document.getElementById("btnBattleAuto");
const btnBattleRetreat=document.getElementById("btnBattleRetreat");
const btnBattleFinish=document.getElementById("btnBattleFinish");

let battleState=null;
// {attFrom,attOwner,toId,att:{INF,ARC,CAV},def:{INF,ARC,CAV},defense,finished,retreated}

function openBattle({attFrom, attOwner, toId, att}){
  const dest=byId(toId);
  battleState={
    attFrom, attOwner, toId,
    att: cloneTroops(att),
    def: cloneTroops(dest.troops),
    defense: dest.defense,
    finished:false, retreated:false
  };
  battleLog.innerHTML="";
  battleHeader.textContent=`ê³µê²©: ${byId(attFrom).name} (${attOwner}) â†’ ë°©ì–´: ${dest.name} (${dest.owner})`;
  syncBattleUI();
  battleOverlay.style.display="flex";
}
function syncBattleUI(){
  const s=battleState; if(!s) return;
  eAttINF.textContent=s.att.INF; eAttARC.textContent=s.att.ARC; eAttCAV.textContent=s.att.CAV;
  eDefINF.textContent=s.def.INF; eDefARC.textContent=s.def.ARC; eDefCAV.textContent=s.def.CAV;
  eDefDefense.textContent=s.defense;
  btnBattleFinish.disabled=!s.finished;
}

function battleRoundOnce(){
  const s=battleState; if(!s || s.finished) return;

  // ê³µê²©ì¸¡ì´ ë³‘ì¢…ë³„ë¡œ ìˆ˜ë¹„ ë³‘ì¢…ì— ê°€í•˜ëŠ” ìœ íš¨ í™”ë ¥ ê³„ì‚°
  // ê°„ë‹¨ ëª¨ë¸: ê° ë³‘ì¢… ê³µê²©ë ¥ = ë³‘ë ¥ * (ê¸°ë³¸ 0.18~0.26) * ìƒì„±ë°°ìˆ˜
  const rand = (a,b)=> a + Math.random()*(b-a);
  let defLoss={INF:0,ARC:0,CAV:0}, attLoss={INF:0,ARC:0,CAV:0};

  // ê³µê²© -> ìˆ˜ë¹„ í”¼í•´
  TYPES.forEach(aType=>{
    const base = s.att[aType];
    if(base<=0) return;
    TYPES.forEach(dType=>{
      const mult = COUNTER[aType][dType];
      const power = Math.floor(base * rand(0.18,0.26) * mult);
      defLoss[dType] += power;
    });
  });

  // ìˆ˜ë¹„ -> ê³µê²© ë°˜ê²© (ë°©ì–´ ë³´ì •: defenseê°€ ë†’ì„ìˆ˜ë¡ ë°˜ê²© íš¨ìœ¨ ì¦ê°€ & í”¼í•´ê°ì†Œ)
  TYPES.forEach(dType=>{
    const base = s.def[dType];
    if(base<=0) return;
    TYPES.forEach(aType=>{
      const mult = COUNTER[dType][aType]; // ìˆ˜ë¹„ ë³‘ì¢… ê¸°ì¤€ì˜ ìƒì„±(ê·¸ëŒ€ë¡œ ì‚¬ìš©)
      const power = Math.floor(base * rand(0.12,0.20) * mult * (1 + s.defense*0.08));
      attLoss[aType] += power;
    });
  });

  // ë°©ì–´ë„ì— ë”°ë¥¸ í”¼í•´ê°ì†Œ(ìˆ˜ë¹„ ìª½ë§Œ)
  TYPES.forEach(t=>{
    defLoss[t] = Math.max(0, Math.floor(defLoss[t] * (1 - Math.min(0.45, s.defense*0.07))));
  });

  // ì ìš©
  TYPES.forEach(t=>{
    s.def[t] = Math.max(0, s.def[t] - defLoss[t]);
    s.att[t] = Math.max(0, s.att[t] - attLoss[t]);
  });

  // ë¡œê·¸
  const line = `ë¼ìš´ë“œ â–¶ ìˆ˜ë¹„í”¼í•´(ë³´${defLoss.INF} ê¶${defLoss.ARC} ê¸°${defLoss.CAV}) / ê³µê²©í”¼í•´(ë³´${attLoss.INF} ê¶${attLoss.ARC} ê¸°${attLoss.CAV})
   â†’ ì”ì—¬: ê³µ(ë³´${s.att.INF} ê¶${s.att.ARC} ê¸°${s.att.CAV}) / ìˆ˜(ë³´${s.def.INF} ê¶${s.def.ARC} ê¸°${s.def.CAV})`;
  const d=document.createElement("div"); d.textContent=line; battleLog.appendChild(d); battleLog.scrollTop=battleLog.scrollHeight;

  // ì¢…ë£Œ íŒì •
  if(!isAnyPositive(s.att) || !isAnyPositive(s.def)){ s.finished=true; }
  syncBattleUI();
}

btnBattleRound.onclick=battleRoundOnce;
btnBattleAuto.onclick=()=>{
  let guard=0; while(battleState && !battleState.finished && guard<64){ battleRoundOnce(); guard++; }
};
btnBattleRetreat.onclick=()=>{
  if(!battleState || battleState.finished) return;
  battleState.retreated=true; battleState.finished=true;
  const d=document.createElement("div"); d.innerHTML="<b>í‡´ê°!</b>"; battleLog.appendChild(d); battleLog.scrollTop=battleLog.scrollHeight;
  syncBattleUI();
};
btnBattleFinish.onclick=()=>{
  const s=battleState; if(!s || !s.finished) return;
  const dest=byId(s.toId);
  if(s.retreated){
    // ë‚¨ì€ ê³µê²© ë³‘ë ¥ ê·€í™˜
    if(isAnyPositive(s.att)){ addTroops(byId(s.attFrom).troops, s.att); log(`í‡´ê°: ${byId(s.attFrom).name}ë¡œ ë³‘ë ¥ ê·€í™˜ (ë³´${s.att.INF} ê¶${s.att.ARC} ê¸°${s.att.CAV})`); }
  }else{
    const attSum=sumTroops(s.att), defSum=sumTroops(s.def);
    if(defSum<=0 && attSum>0){
      dest.owner=s.attOwner;
      dest.troops=cloneTroops(s.att);
      dest.defense=Math.max(0, dest.defense-1);
      log(`í•¨ë½! ${dest.name} -> ${s.attOwner} (ë³´${s.att.INF} ê¶${s.att.ARC} ê¸°${s.att.CAV})`);
    }else{
      dest.troops=cloneTroops(s.def);
      if(attSum>0){ addTroops(byId(s.attFrom).troops, s.att); log(`ê³µê²© ì‹¤íŒ¨. ${byId(s.attFrom).name}ë¡œ ë³‘ë ¥ ê·€í™˜ (ë³´${s.att.INF} ê¶${s.att.ARC} ê¸°${s.att.CAV})`); }
      log(`ë°©ì–´ ì„±ê³µ: ${dest.name} ì”ì¡´ (ë³´${s.def.INF} ê¶${s.def.ARC} ê¸°${s.def.CAV})`);
    }
  }
  battleOverlay.style.display="none"; battleState=null;
  draw(); refreshInfo(); updateTop();
};

/* ===== ì´ë™/ì „íˆ¬ ì—°ê²° ===== */
function resolveMovementsOrOpenBattles(){
  const idx=movements.findIndex(m=>m.turnsLeft<=0);
  if(idx===-1) return false;
  const m=movements[idx], dest=byId(m.to);
  if(dest.owner===m.owner){
    addTroops(dest.troops, m.troops);
    log(`í•©ë¥˜: ${dest.name} ì— ë³‘ë ¥ (ë³´${m.troops.INF} ê¶${m.troops.ARC} ê¸°${m.troops.CAV})`);
    movements.splice(idx,1);
    return true;
  }else{
    openBattle({attFrom:m.from, attOwner:m.owner, toId:m.to, att:m.troops});
    movements.splice(idx,1);
    return true;
  }
}
function resolveMovementsStepwise(){
  for(let i=0;i<movements.length;i++){ movements[i].turnsLeft--; }
  while(true){
    const progressed=resolveMovementsOrOpenBattles();
    if(!progressed) break;
    if(battleState) break;
  }
}

/* ===== AI (ê°„ë‹¨) ===== */
function aiPhase(){
  const aiCities=cities.filter(c=>c.owner===ENEMY && sumTroops(c.troops)>=12);
  for(const from of aiCities){
    const targets=from.adj.map(id=>byId(id)).filter(t=>t.owner!==ENEMY);
    if(targets.length===0) continue;
    targets.sort((a,b)=>(sumTroops(a.troops)+a.defense*2)-(sumTroops(b.troops)+b.defense*2));
    const to=targets[0];
    const send=cloneTroops({
      INF: Math.floor(from.troops.INF/2),
      ARC: Math.floor(from.troops.ARC/2),
      CAV: Math.floor(from.troops.CAV/2),
    });
    if(sumTroops(send)>0){
      subTroops(from.troops, send);
      movements.push({from:from.id,to:to.id,owner:ENEMY,troops:send,turnsLeft:1});
      log(`(AI) í–‰êµ°: ${from.name} â†’ ${to.name} (ë³´${send.INF} ê¶${send.ARC} ê¸°${send.CAV})`);
    }
  }
}

/* ===== í„´ ì¢…ë£Œ ===== */
function endTurn(){
  gold+=incomeOf(PLAYER); // ìˆ˜ì…
  resolveMovementsStepwise(); if(battleState){ updateTop(); draw(); refreshInfo(); return; }
  aiPhase();
  resolveMovementsStepwise(); if(battleState){ updateTop(); draw(); refreshInfo(); return; }
  turn++; updateTop(); draw(); refreshInfo();
}

/* ===== ì´ˆê¸°í™” ===== */
function bootstrap(){ updateTop(); refreshInfo(); draw(); log("ê²Œì„ ì‹œì‘. í”Œë ˆì´ì–´ì˜ í„´ì…ë‹ˆë‹¤."); }
bootstrap();
</script>
</body>
</html>
