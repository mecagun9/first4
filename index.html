<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>ì‚¼êµ­ì§€3 ìŠ¤íƒ€ì¼ í„´ì œ + ì „íˆ¬ + ë³‘ì¢… + ì˜ì›… ì–´ë“œë°´í‹°ì§€(í†µí•©)</title>
<style>
  body{margin:0;background:#1a1d24;color:#eaeaea;font-family:system-ui,apple-system,sans-serif}
  #wrap{display:flex;gap:12px;padding:12px}
  #left{flex:0 0 760px}
  #right{flex:1;display:flex;flex-direction:column;gap:8px}
  canvas{background:#0f1115;border:1px solid #333;border-radius:8px;display:block}
  .panel{background:#12151c;border:1px solid #2a2e38;border-radius:8px;padding:10px}
  h3{margin:0 0 8px 0;font-size:14px;color:#8bd0ff}
  button{background:#2a3242;border:1px solid #445169;color:#eaeaea;border-radius:6px;padding:8px 10px;cursor:pointer}
  button:disabled{opacity:.5;cursor:not-allowed}
  .row{display:flex;gap:6px;flex-wrap:wrap}
  .kv{font-size:12px;opacity:.95}
  input[type=number]{width:76px;background:#0f1115;color:#fff;border:1px solid #2a2e38;border-radius:6px;padding:6px}
  small{opacity:.8}

  /* ì „íˆ¬ ì˜¤ë²„ë ˆì´ */
  #battleOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.65);z-index:9999}
  #battleBox{width:840px;background:#0f1115;border:1px solid #2a2e38;border-radius:10px;padding:16px}
  #battleLog{height:180px;overflow:auto;background:#11151d;border:1px solid #2a2e38;border-radius:8px;padding:8px;font-size:12px}
  .cols{display:flex;gap:12px}
  .col{flex:1}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{border:1px solid #2a2e38;padding:4px;text-align:center}
  .muted{opacity:.7}
</style>
</head>
<body>
<div id="wrap">
  <div id="left"><canvas id="map" width="760" height="600"></canvas></div>
  <div id="right">
    <div class="panel">
      <h3>í„´ / ìì›</h3>
      <div class="kv">í˜„ì¬ í„´: <b id="turn">1</b></div>
      <div class="kv">ê¸ˆ: <b id="gold">200</b> G</div>
      <div class="kv">ìˆ˜ì…(í„´ë‹¹): <b id="income">0</b> G</div>
      <div class="kv muted">ëª¨ì§‘ ë¹„ìš©: ë³´ë³‘ 1G / ê¶ìˆ˜ 2G / ê¸°ë³‘ 3G</div>
    </div>

    <div class="panel">
      <h3>ê±°ì  ì •ë³´</h3>
      <div id="cityInfo" class="kv">ê±°ì ì„ í´ë¦­í•˜ì„¸ìš”.</div>
    </div>

    <div class="panel">
      <h3>ëª…ë ¹</h3>
      <div class="row">
        <button id="btnMove" disabled>ì´ë™</button>
        <button id="btnRecruit" disabled>ëª¨ì§‘</button>
        <button id="btnFortify" disabled>ìš”ìƒˆí™”</button>
        <button id="btnCancel" disabled>ì·¨ì†Œ</button>
      </div>
      <div id="cmdArea" style="margin-top:8px;"></div>
      <div style="margin-top:8px"><button id="btnEnd">í„´ ì¢…ë£Œ â–¶</button></div>
      <small>
        â€¢ ì´ë™: ì¸ì ‘ ê±°ì ë§Œ, 1í„´ ì†Œìš” â†’ ì /ì¤‘ë¦½ ë„ì°© ì‹œ <b>ì „íˆ¬ í™”ë©´</b><br>
        â€¢ ì´ë™ ëª…ë ¹ì°½ì—ì„œ <b>ì˜ì›… ë™í–‰</b> ì²´í¬ ê°€ëŠ¥ (í•´ë‹¹ ë„ì‹œ ë°°ì† ì˜ì›…)<br>
        â€¢ ëª¨ì§‘: ë³‘ì¢…ë³„ ë¹„ìš© ìƒì´(ìƒë‹¨ ì°¸ê³ ) â€¢ ìš”ìƒˆí™”: 10Gë¡œ ë°©ì–´ +1 (ìµœëŒ€ +5)
      </small>
    </div>

    <div class="panel">
      <h3>ë¡œê·¸</h3>
      <div id="log" style="height:220px;overflow:auto;font-size:12px;line-height:1.4"></div>
    </div>
  </div>
</div>

<!-- ì „íˆ¬ ì˜¤ë²„ë ˆì´ -->
<div id="battleOverlay">
  <div id="battleBox">
    <h3>ì „íˆ¬</h3>
    <div id="battleHeader" class="kv">ê³µê²©: ? â†’ ë°©ì–´: ?</div>

    <div class="row muted" style="gap:16px;margin:8px 0">
      <div>ê³µê²© ì˜ì›…: <b id="attHeroName">ì—†ìŒ</b></div>
      <div>ë°©ì–´ ì˜ì›…: <b id="defHeroName">ì—†ìŒ</b></div>
    </div>

    <div class="cols" style="margin-bottom:8px">
      <div class="col">
        <table>
          <thead><tr><th colspan="3">ê³µê²© ë³‘ë ¥</th></tr></thead>
          <tbody>
            <tr><td>ë³´ë³‘</td><td>ê¶ìˆ˜</td><td>ê¸°ë³‘</td></tr>
            <tr><td id="attINF">0</td><td id="attARC">0</td><td id="attCAV">0</td></tr>
          </tbody>
        </table>
      </div>
      <div class="col">
        <table>
          <thead><tr><th colspan="3">ìˆ˜ë¹„ ë³‘ë ¥</th></tr></thead>
          <tbody>
            <tr><td>ë³´ë³‘</td><td>ê¶ìˆ˜</td><td>ê¸°ë³‘</td></tr>
            <tr><td id="defINF">0</td><td id="defARC">0</td><td id="defCAV">0</td></tr>
          </tbody>
        </table>
        <div class="kv" style="margin-top:6px">ë°©ì–´: <b id="defDefense">0</b></div>
      </div>
    </div>

    <div class="row" style="margin-bottom:8px">
      <button id="btnBattleRound">ë‹¤ìŒ ë¼ìš´ë“œ</button>
      <button id="btnBattleAuto">ìë™ ì „íˆ¬</button>
      <button id="btnBattleRetreat">ê³µê²© ì¤‘ì§€(í‡´ê°)</button>
      <button id="btnBattleFinish" disabled>ì „íˆ¬ ì¢…ë£Œ(ê²°ê³¼ ë°˜ì˜)</button>
    </div>

    <div class="muted" style="margin-bottom:6px">
      â€» ì˜ì›… ì–´ë“œë°´í‹°ì§€: ì  ë³‘ì¢… ë¹„ìœ¨ì„ ê¸°ë°˜ìœ¼ë¡œ í”¼í•´ ë³´ì •(ì˜¤ë¼+ìƒì„±), ì‚¬ê¸° ë³´ë„ˆìŠ¤ëŠ” ì „íˆ¬ë ¥ì— ê°€ì‚°
    </div>
    <div id="battleLog"></div>
  </div>
</div>

<script>
/* ===== ë³‘ì¢…/ë¹„ìš©/ìƒì„± ===== */
const TYPES=["INF","ARC","CAV"]; // ë³´ë³‘/ê¶ìˆ˜/ê¸°ë³‘
const TYPE_NAME={INF:"ë³´ë³‘",ARC:"ê¶ìˆ˜",CAV:"ê¸°ë³‘"};
const TRAIN_COST={INF:1,ARC:2,CAV:3};
const COUNTER={
  INF:{INF:1.0,ARC:1.25,CAV:0.85},
  ARC:{INF:0.9,ARC:1.0,CAV:1.25},
  CAV:{INF:1.25,ARC:0.85,CAV:1.0}
};

/* ===== ì˜ì›…(ìƒ˜í”Œ) ===== */
const heroes={
  H01:{id:"H01",name:"ê´€ì˜",inTransit:false,
       aura:{atkPct:0.10,defPct:0.05},
       advantage:{INF:0.20,ARC:0.10,CAV:0.00}, // ì  ë³‘ì¢… ë¹„ìœ¨ ê¸°ë°˜ ì¶”ê°€ ê³µê²© ë³´ë„ˆìŠ¤
       moraleBoost:5},
  H02:{id:"H02",name:"ì¥ê´‘",inTransit:false,
       aura:{atkPct:0.05,defPct:0.10},
       advantage:{INF:0.00,ARC:0.20,CAV:0.10},
       moraleBoost:8}
};

/* ===== ê¸°ë³¸ ìƒìˆ˜ ë° ìƒíƒœ ===== */
const PLAYER="player", ENEMY="enemy", NEUT="neutral";
const cities=[
  {id:"JI",name:"ê³„(ê³„ì„±)",x:120,y:90, owner:PLAYER, troops:{INF:30,ARC:6,CAV:4},defense:1,income:12,adj:["YE","BO"],heroId:"H01"},
  {id:"YE",name:"ì—…",     x:210,y:120,owner:PLAYER, troops:{INF:20,ARC:6,CAV:4},defense:1,income:10,adj:["JI","BO","PU"],heroId:null},
  {id:"BO",name:"ë°•",     x:170,y:180,owner:NEUT,   troops:{INF:12,ARC:2,CAV:1},defense:0,income:6, adj:["JI","YE","PU","CH"],heroId:null},
  {id:"PU",name:"ë¶€",     x:260,y:190,owner:ENEMY,  troops:{INF:20,ARC:6,CAV:4},defense:1,income:9, adj:["YE","BO","CH","LU"],heroId:"H02"},
  {id:"CH",name:"í—ˆ/ì°½",  x:220,y:250,owner:NEUT,   troops:{INF:8, ARC:1,CAV:1},defense:0,income:6, adj:["BO","PU","LU","RU"],heroId:null},
  {id:"LU",name:"ë‚™ì–‘",   x:295,y:255,owner:ENEMY,  troops:{INF:18,ARC:4,CAV:3},defense:1,income:9, adj:["PU","CH","RU"],heroId:null},
  {id:"RU",name:"ì—¬ë‚¨",   x:260,y:320,owner:NEUT,   troops:{INF:9, ARC:2,CAV:1},defense:0,income:6, adj:["CH","LU","SH"],heroId:null},
  {id:"SH",name:"ìˆ˜ì¶˜",   x:310,y:380,owner:ENEMY,  troops:{INF:16,ARC:4,CAV:2},defense:1,income:8, adj:["RU","GU"],heroId:null},
  {id:"GU",name:"ê´‘ë¦‰",   x:360,y:330,owner:NEUT,   troops:{INF:8, ARC:1,CAV:1},defense:0,income:6, adj:["SH","QH"],heroId:null},
  {id:"QH",name:"ê±´ì—…",   x:420,y:360,owner:ENEMY,  troops:{INF:18,ARC:6,CAV:4},defense:1,income:10,adj:["GU","HU"],heroId:null},
  {id:"HU",name:"íšŒê³„",   x:520,y:390,owner:NEUT,   troops:{INF:7, ARC:2,CAV:1},defense:0,income:6, adj:["QH"],heroId:null},
  {id:"PI",name:"ë¶í‰",   x:140,y:40, owner:NEUT,   troops:{INF:6, ARC:1,CAV:1},defense:0,income:5, adj:["JI"],heroId:null},
];
let turn=1,gold=200;
let movements=[]; // {from,to,owner,troops:{INF,ARC,CAV},heroId|null,turnsLeft}
let selectedId=null,mode="idle",moveFrom=null;

const logEl=document.getElementById("log");
const byId=id=>cities.find(c=>c.id===id);
const sumTroops=t=>TYPES.reduce((s,k)=>s+(t[k]||0),0);
function addTroops(a,b){TYPES.forEach(k=>a[k]=(a[k]||0)+(b[k]||0));}
function subTroops(a,b){TYPES.forEach(k=>a[k]=(a[k]||0)-(b[k]||0));}
function cloneTroops(t){return {INF:t.INF||0,ARC:t.ARC||0,CAV:t.CAV||0};}
function isAnyPositive(t){return TYPES.some(k=> (t[k]||0)>0 );}
function log(msg){const d=document.createElement("div");d.textContent=msg;logEl.appendChild(d);logEl.scrollTop=logEl.scrollHeight;}
function incomeOf(owner){return cities.filter(c=>c.owner===owner).reduce((s,c)=>s+c.income,0);}
function updateTop(){document.getElementById("turn").textContent=turn;document.getElementById("gold").textContent=gold;document.getElementById("income").textContent=incomeOf(PLAYER);}
function heroName(id){return id? heroes[id]?.name || "??" : "ì—†ìŒ";}
function citySummary(c){
  return `ã€${c.name}ã€‘ ${c.owner===PLAYER?'í”Œë ˆì´ì–´':c.owner===ENEMY?'ì ':'ì¤‘ë¦½'} | ë³‘ë ¥:${sumTroops(c.troops)} (ë³´${c.troops.INF} ê¶${c.troops.ARC} ê¸°${c.troops.CAV}) | ë°©ì–´:${c.defense} | ìˆ˜ì…:${c.income} | ì˜ì›…:${heroName(c.heroId)}`;
}
function refreshInfo(){const info=document.getElementById("cityInfo");if(!selectedId){info.textContent="ê±°ì ì„ í´ë¦­í•˜ì„¸ìš”.";return;}info.textContent=citySummary(byId(selectedId));}

/* ===== ë§µ ë Œë”ë§ ===== */
const canvas=document.getElementById("map");
const ctx=canvas.getContext("2d");
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // ì—°ê²°ì„ 
  ctx.lineWidth=2;
  cities.forEach(c=>{c.adj.forEach(a=>{const t=byId(a);ctx.strokeStyle="#2c3647";ctx.beginPath();ctx.moveTo(c.x,c.y);ctx.lineTo(t.x,t.y);ctx.stroke();});});
  // ì´ë™ ì ì„ 
  movements.forEach(m=>{const s=byId(m.from),t=byId(m.to);ctx.setLineDash([6,6]);ctx.strokeStyle="#bbb";ctx.beginPath();ctx.moveTo(s.x,s.y);ctx.lineTo(t.x,t.y);ctx.stroke();ctx.setLineDash([]);});
  // ë…¸ë“œ
  cities.forEach(c=>{
    ctx.beginPath();ctx.arc(c.x,c.y,18,0,Math.PI*2);
    ctx.fillStyle=c.owner===PLAYER?"#3aa76d":c.owner===ENEMY?"#d94a4a":"#777";
    ctx.fill();ctx.lineWidth=2;ctx.strokeStyle="#0e0e0e";ctx.stroke();
    if(c.id===selectedId){ctx.beginPath();ctx.arc(c.x,c.y,22,0,Math.PI*2);ctx.strokeStyle="#ffde6b";ctx.lineWidth=2;ctx.stroke();}
    if(c.defense>0){ctx.fillStyle="#ffde6b";ctx.font="12px sans-serif";ctx.textAlign="center";ctx.fillText("ğŸ›¡"+c.defense, c.x, c.y+32);}
    if(c.heroId){ctx.fillStyle="#ffd27f";ctx.font="11px sans-serif";ctx.textAlign="center";ctx.fillText("â˜…"+heroName(c.heroId), c.x, c.y+46);}
    ctx.fillStyle="#eaeaea";ctx.font="12px sans-serif";ctx.textAlign="center";
    ctx.fillText(c.name, c.x, c.y-26);
    ctx.fillText(`å…µ:${sumTroops(c.troops)}`, c.x, c.y-10);
  });
}
function cityAt(x,y){return cities.find(c=>{const dx=x-c.x,dy=y-c.y;return dx*dx+dy*dy<=18*18+8;})?.id||null;}

/* ===== ëª…ë ¹ UI ===== */
const btnMove=document.getElementById("btnMove");
const btnRecruit=document.getElementById("btnRecruit");
const btnFortify=document.getElementById("btnFortify");
const btnCancel=document.getElementById("btnCancel");
const btnEnd=document.getElementById("btnEnd");
const cmdArea=document.getElementById("cmdArea");

function setButtons(){
  const sel=selectedId?byId(selectedId):null;
  btnMove.disabled=!(sel && sel.owner===PLAYER && sumTroops(sel.troops)>0);
  btnRecruit.disabled=!(sel && sel.owner===PLAYER);
  btnFortify.disabled=!(sel && sel.owner===PLAYER && sel.defense<5 && gold>=10);
  btnCancel.disabled=(mode==="idle");
}
btnMove.onclick=()=>{
  if(!selectedId) return; mode="movePick"; moveFrom=selectedId;
  cmdArea.innerHTML=`<div class="kv">ì´ë™ ëŒ€ìƒ ê±°ì ì„ í´ë¦­í•˜ì„¸ìš”. (ì¸ì ‘ë§Œ)</div>`;
  setButtons();
};
btnRecruit.onclick=()=>{
  if(!selectedId) return; mode="recruit";
  const c=byId(selectedId);
  cmdArea.innerHTML=`
    <div class="kv">ëª¨ì§‘ ìˆ˜ (ë¹„ìš©: ë³´1G/ê¶2G/ê¸°3G)</div>
    <div class="row">
      <div>ë³´ë³‘: <input type="number" id="rcINF" min="0" value="0"></div>
      <div>ê¶ìˆ˜: <input type="number" id="rcARC" min="0" value="0"></div>
      <div>ê¸°ë³‘: <input type="number" id="rcCAV" min="0" value="0"></div>
      <button id="doRecruit">í™•ì¸</button>
    </div>
  `;
  document.getElementById("doRecruit").onclick=()=>{
    const INF=+document.getElementById("rcINF").value||0;
    const ARC=+document.getElementById("rcARC").value||0;
    const CAV=+document.getElementById("rcCAV").value||0;
    const cost=INF*TRAIN_COST.INF + ARC*TRAIN_COST.ARC + CAV*TRAIN_COST.CAV;
    if(cost>gold){log(`ê¸ˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤. í•„ìš”:${cost}G, ë³´ìœ :${gold}G`);return;}
    c.troops.INF+=INF;c.troops.ARC+=ARC;c.troops.CAV+=CAV;gold-=cost;
    log(`ã€${c.name}ã€‘ ëª¨ì§‘: ë³´${INF} ê¶${ARC} ê¸°${CAV} (-${cost}G)`); mode="idle"; cmdArea.innerHTML="";
    updateTop(); refreshInfo(); draw(); setButtons();
  };
  setButtons();
};
btnFortify.onclick=()=>{
  if(!selectedId) return; const c=byId(selectedId);
  if(c.defense>=5 || gold<10) return;
  c.defense+=1; gold-=10; log(`ã€${c.name}ã€‘ ìš”ìƒˆí™” +1 (ë°©ì–´ ${c.defense}, ê¸ˆ:${gold})`);
  refreshInfo(); updateTop(); draw(); setButtons();
};
btnCancel.onclick=()=>{mode="idle";moveFrom=null;cmdArea.innerHTML="";setButtons();};
btnEnd.onclick=endTurn;

/* ë§µ í´ë¦­ */
canvas.addEventListener("click",(e)=>{
  const rect=canvas.getBoundingClientRect(); const x=e.clientX-rect.left,y=e.clientY-rect.top;
  const hit=cityAt(x,y); if(!hit) return;
  selectedId=hit; refreshInfo(); setButtons(); draw();

  if(mode==="movePick" && moveFrom){
    if(moveFrom===hit) return;
    const from=byId(moveFrom), to=byId(hit);
    if(!from.adj.includes(to.id)){log("ì¸ì ‘ ê±°ì ë§Œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");return;}
    if(from.owner!==PLAYER){log("ì†Œìœ  ê±°ì ì—ì„œë§Œ ì´ë™í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");return;}
    if(sumTroops(from.troops)<=0){log("ë³‘ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.");return;}

    // ë³‘ì¢…ë³„ ì´ë™ + ì˜ì›… ë™í–‰ ì²´í¬
    mode="idle";
    const heroChk = from.heroId ? `<label><input type="checkbox" id="chkHero" ${heroes[from.heroId].inTransit?'disabled':''}> ì˜ì›… ë™í–‰ (${heroName(from.heroId)})</label>` : `<span class="muted">ì˜ì›… ì—†ìŒ</span>`;
    cmdArea.innerHTML=`
      <div class="kv">ì´ë™ ë³‘ë ¥ ì…ë ¥ (ìµœëŒ€: ë³´${from.troops.INF} ê¶${from.troops.ARC} ê¸°${from.troops.CAV})</div>
      <div class="row">
        <div>ë³´ë³‘: <input type="number" id="mvINF" min="0" max="${from.troops.INF}" value="${Math.min(from.troops.INF, Math.floor(from.troops.INF/2))}"></div>
        <div>ê¶ìˆ˜: <input type="number" id="mvARC" min="0" max="${from.troops.ARC}" value="${Math.min(from.troops.ARC, Math.floor(from.troops.ARC/2))}"></div>
        <div>ê¸°ë³‘: <input type="number" id="mvCAV" min="0" max="${from.troops.CAV}" value="${Math.min(from.troops.CAV, Math.floor(from.troops.CAV/2))}"></div>
      </div>
      <div class="kv" style="margin-top:6px">${heroChk}</div>
      <button id="doMove">ì´ë™</button>
    `;
    document.getElementById("doMove").onclick=()=>{
      const INF=+document.getElementById("mvINF").value||0;
      const ARC=+document.getElementById("mvARC").value||0;
      const CAV=+document.getElementById("mvCAV").value||0;
      const withHero = from.heroId && !heroes[from.heroId].inTransit && (document.getElementById("chkHero")?.checked||false);
      if(INF>from.troops.INF||ARC>from.troops.ARC||CAV>from.troops.CAV){log("ë³‘ë ¥ ì´ˆê³¼ ì…ë ¥ì…ë‹ˆë‹¤.");return;}
      if(INF+ARC+CAV<=0 && !withHero){log("ì´ë™ ë³‘ë ¥ ë˜ëŠ” ì˜ì›… ë™í–‰ì„ ì„ íƒí•˜ì„¸ìš”.");return;}

      from.troops.INF-=INF; from.troops.ARC-=ARC; from.troops.CAV-=CAV;
      const mv={from:from.id,to:to.id,owner:from.owner,troops:{INF,ARC,CAV},heroId:withHero?from.heroId:null,turnsLeft:1};
      if(withHero){heroes[from.heroId].inTransit=true; from.heroId=null;}
      movements.push(mv);
      log(`í–‰êµ°: ${from.name} â†’ ${to.name} (ë³´${INF} ê¶${ARC} ê¸°${CAV}${withHero?`, ì˜ì›… ë™í–‰`:``})`);
      cmdArea.innerHTML=""; draw(); refreshInfo(); setButtons();
    };
    moveFrom=null;
  }
});

/* ===== ì „íˆ¬ ì˜¤ë²„ë ˆì´ ===== */
const battleOverlay=document.getElementById("battleOverlay");
const battleHeader=document.getElementById("battleHeader");
const eAttINF=document.getElementById("attINF"),eAttARC=document.getElementById("attARC"),eAttCAV=document.getElementById("attCAV");
const eDefINF=document.getElementById("defINF"),eDefARC=document.getElementById("defARC"),eDefCAV=document.getElementById("defCAV");
const eDefDefense=document.getElementById("defDefense");
const eAttHeroName=document.getElementById("attHeroName");
const eDefHeroName=document.getElementById("defHeroName");
const battleLog=document.getElementById("battleLog");
const btnBattleRound=document.getElementById("btnBattleRound");
const btnBattleAuto=document.getElementById("btnBattleAuto");
const btnBattleRetreat=document.getElementById("btnBattleRetreat");
const btnBattleFinish=document.getElementById("btnBattleFinish");

let battleState=null;
// {attFrom,attOwner,toId,att:{},def:{},defense,attHeroId,defHeroId,finished,retreated}

function openBattle({attFrom, attOwner, toId, att, heroId}){
  const dest=byId(toId);
  battleState={
    attFrom, attOwner, toId,
    att: cloneTroops(att),
    def: cloneTroops(dest.troops),
    defense: dest.defense,
    attHeroId: heroId || null,
    defHeroId: dest.heroId || null,
    finished:false, retreated:false
  };
  battleLog.innerHTML="";
  battleHeader.textContent=`ê³µê²©: ${byId(attFrom).name} (${attOwner}) â†’ ë°©ì–´: ${dest.name} (${dest.owner})`;
  eAttHeroName.textContent = heroName(battleState.attHeroId);
  eDefHeroName.textContent = heroName(battleState.defHeroId);
  syncBattleUI();
  battleOverlay.style.display="flex";
}
function syncBattleUI(){
  const s=battleState; if(!s) return;
  eAttINF.textContent=s.att.INF; eAttARC.textContent=s.att.ARC; eAttCAV.textContent=s.att.CAV;
  eDefINF.textContent=s.def.INF; eDefARC.textContent=s.def.ARC; eDefCAV.textContent=s.def.CAV;
  eDefDefense.textContent=s.defense;
  btnBattleFinish.disabled=!s.finished;
}

/* ===== ì˜ì›… ì–´ë“œë°´í‹°ì§€/ì˜¤ë¼/ì‚¬ê¸° ë²„í”„ ===== */
function getHeroBuff(side, enemyTroops){
  const id = side==='att'? battleState.attHeroId : battleState.defHeroId;
  if(!id) return {atkMul:1, defMul:1, morale:0};
  const h=heroes[id]; const aura=h.aura||{}; const adv=h.advantage||{};
  const total=sumTroops(enemyTroops); let advBonus=0;
  if(total>0){ TYPES.forEach(tp=>{ const portion=(enemyTroops[tp]||0)/total; advBonus += (adv[tp]||0)*portion; }); }
  return { atkMul:1+(aura.atkPct||0)+advBonus, defMul:1+(aura.defPct||0), morale:h.moraleBoost||0 };
}

/* ===== ì „íˆ¬ 1ë¼ìš´ë“œ =====
   - íƒ€ì… ìƒì„±(COUNTER) + ëœë¤ + ì˜ì›… ì˜¤ë¼/ì–´ë“œë°´í‹°ì§€/ì‚¬ê¸°
   - ìˆ˜ë¹„ëŠ” ìš”ìƒˆ(ë°©ì–´ë„)ë¡œ í”¼í•´ê°ì†Œ ë° ë°˜ê²© ê°•í™”
*/
function battleRoundOnce(){
  const s=battleState; if(!s || s.finished) return;
  const rand=(a,b)=> a + Math.random()*(b-a);

  const attBuff=getHeroBuff('att', s.def);
  const defBuff=getHeroBuff('def', s.att);

  let defLoss={INF:0,ARC:0,CAV:0}, attLoss={INF:0,ARC:0,CAV:0};

  // ê³µê²© -> ìˆ˜ë¹„ í”¼í•´ (ìƒì„± + ì˜¤ë¼/ì–´ë“œë°´í‹°ì§€ + ì‚¬ê¸°)
  TYPES.forEach(aType=>{
    const base = s.att[aType]; if(base<=0) return;
    TYPES.forEach(dType=>{
      const mult=COUNTER[aType][dType];
      const power = Math.floor( base * rand(0.18,0.26) * mult * attBuff.atkMul * (1 + attBuff.morale/100) );
      defLoss[dType] += power;
    });
  });

  // ìˆ˜ë¹„ -> ê³µê²© ë°˜ê²© (ë°©ì–´ë„ ì˜í–¥ìœ¼ë¡œ ê°•í™”)
  TYPES.forEach(dType=>{
    const base = s.def[dType]; if(base<=0) return;
    TYPES.forEach(aType=>{
      const mult=COUNTER[dType][aType];
      const power = Math.floor( base * rand(0.12,0.20) * mult * defBuff.defMul * (1 + defBuff.morale/100) * (1 + s.defense*0.08) );
      attLoss[aType] += power;
    });
  });

  // ë°©ì–´ë„ì— ë”°ë¥¸ ìˆ˜ë¹„ í”¼í•´ê°ì†Œ(ìˆ˜ë¹„ì¸¡ì´ ë°›ëŠ” í”¼í•´)
  TYPES.forEach(t=>{
    defLoss[t] = Math.max(0, Math.floor(defLoss[t] * (1 - Math.min(0.45, s.defense*0.07))));
  });

  // ì ìš©(0 í•˜í•œ)
  TYPES.forEach(t=>{
    s.def[t]=Math.max(0, s.def[t]-defLoss[t]);
    s.att[t]=Math.max(0, s.att[t]-attLoss[t]);
  });

  const line=`ë¼ìš´ë“œ â–¶ ìˆ˜ë¹„í”¼í•´(ë³´${defLoss.INF} ê¶${defLoss.ARC} ê¸°${defLoss.CAV}) / ê³µê²©í”¼í•´(ë³´${attLoss.INF} ê¶${attLoss.ARC} ê¸°${attLoss.CAV})
   â†’ ì”ì—¬: ê³µ(ë³´${s.att.INF} ê¶${s.att.ARC} ê¸°${s.att.CAV}) / ìˆ˜(ë³´${s.def.INF} ê¶${s.def.ARC} ê¸°${s.def.CAV})`;
  const d=document.createElement("div"); d.textContent=line; battleLog.appendChild(d); battleLog.scrollTop=battleLog.scrollHeight;

  if(!isAnyPositive(s.att) || !isAnyPositive(s.def)){ s.finished=true; }
  syncBattleUI();
}
btnBattleRound.onclick=battleRoundOnce;
btnBattleAuto.onclick=()=>{let guard=0;while(battleState && !battleState.finished && guard<64){battleRoundOnce();guard++;}};
btnBattleRetreat.onclick=()=>{if(!battleState||battleState.finished) return;battleState.retreated=true;battleState.finished=true;const d=document.createElement("div");d.innerHTML="<b>í‡´ê°!</b>";battleLog.appendChild(d);battleLog.scrollTop=battleLog.scrollHeight;syncBattleUI();};
btnBattleFinish.onclick=()=>{
  const s=battleState; if(!s||!s.finished) return; const dest=byId(s.toId);

  if(s.retreated){
    // ê³µê²© ì¸¡ ì”ì—¬ ë³‘ë ¥ ê·€í™˜ + ì˜ì›… ë³µê·€
    if(isAnyPositive(s.att)){ addTroops(byId(s.attFrom).troops, s.att); log(`í‡´ê°: ${byId(s.attFrom).name}ë¡œ ë³‘ë ¥ ê·€í™˜ (ë³´${s.att.INF} ê¶${s.att.ARC} ê¸°${s.att.CAV})`); }
    if(s.attHeroId){ byId(s.attFrom).heroId=s.attHeroId; heroes[s.attHeroId].inTransit=false; log(`ì˜ì›… ${heroName(s.attHeroId)} í‡´ê° í›„ ${byId(s.attFrom).name} ë³µê·€`); }
  }else{
    const attSum=sumTroops(s.att), defSum=sumTroops(s.def);
    if(defSum<=0 && attSum>0){
      // í•¨ë½: ìˆ˜ë¹„ ì˜ì›…ì€ ë„ì£¼(ìŠ¬ë¡¯ ë¹„ì›€), ê³µê²© ì˜ì›… ë¶€ì„
      if(s.defHeroId){ log(`ìˆ˜ë¹„ ì˜ì›… ${heroName(s.defHeroId)} ë„ì£¼`); }
      dest.owner=s.attOwner; dest.troops=cloneTroops(s.att); dest.defense=Math.max(0,dest.defense-1);
      dest.heroId = s.attHeroId || null;
      if(s.attHeroId){ heroes[s.attHeroId].inTransit=false; }
      log(`í•¨ë½! ${dest.name} ì ë ¹${s.attHeroId?` (ì˜ì›… ${heroName(s.attHeroId)} ë¶€ì„)`:""}`);
    }else{
      // ë°©ì–´ ì„±ê³µ: ìˆ˜ë¹„ ì”ì¡´ ìœ ì§€, ê³µê²© ì”ì—¬ëŠ” ì¶œë°œì§€ë¡œ ê·€í™˜, ì˜ì›…ë„ ë³µê·€
      dest.troops=cloneTroops(s.def);
      if(attSum>0){ addTroops(byId(s.attFrom).troops, s.att); log(`ê³µê²© ì‹¤íŒ¨. ${byId(s.attFrom).name}ë¡œ ë³‘ë ¥ ê·€í™˜ (ë³´${s.att.INF} ê¶${s.att.ARC} ê¸°${s.att.CAV})`);}
      if(s.attHeroId){ byId(s.attFrom).heroId=s.attHeroId; heroes[s.attHeroId].inTransit=false; log(`ì˜ì›… ${heroName(s.attHeroId)} ê³µê²© ì‹¤íŒ¨ í›„ ë³µê·€`);}
      log(`ë°©ì–´ ì„±ê³µ: ${dest.name} ì”ì¡´ (ë³´${s.def.INF} ê¶${s.def.ARC} ê¸°${s.def.CAV})`);
    }
  }
  battleOverlay.style.display="none"; battleState=null; draw(); refreshInfo(); updateTop();
};

/* ===== ì´ë™/ì „íˆ¬ ì—°ê²° ===== */
function resolveMovementsOrOpenBattles(){
  const idx=movements.findIndex(m=>m.turnsLeft<=0);
  if(idx===-1) return false;
  const m=movements[idx], dest=byId(m.to);

  if(dest.owner===m.owner){
    addTroops(dest.troops, m.troops);
    if(m.heroId){ dest.heroId=m.heroId; heroes[m.heroId].inTransit=false; log(`ì˜ì›… ${heroName(m.heroId)}ì´(ê°€) ${dest.name}ì— ë¶€ì„`); }
    log(`í•©ë¥˜: ${dest.name} ì— ë³‘ë ¥ (ë³´${m.troops.INF} ê¶${m.troops.ARC} ê¸°${m.troops.CAV})`);
    movements.splice(idx,1); return true;
  }else{
    openBattle({attFrom:m.from, attOwner:m.owner, toId:m.to, att:m.troops, heroId:m.heroId||null});
    movements.splice(idx,1); return true;
  }
}
function resolveMovementsStepwise(){
  for(let i=0;i<movements.length;i++){movements[i].turnsLeft--;}
  while(true){
    const progressed=resolveMovementsOrOpenBattles();
    if(!progressed) break;
    if(battleState) break; // ì „íˆ¬ ë°œìƒ ì‹œ ì¼ì‹œì •ì§€
  }
}

/* ===== AI (ì´ˆê¸°í˜•) ===== */
function aiPhase(){
  const aiCities=cities.filter(c=>c.owner===ENEMY && sumTroops(c.troops)>=12);
  for(const from of aiCities){
    const targets=from.adj.map(id=>byId(id)).filter(t=>t.owner!==ENEMY);
    if(targets.length===0) continue;
    targets.sort((a,b)=>(sumTroops(a.troops)+a.defense*2)-(sumTroops(b.troops)+b.defense*2));
    const to=targets[0];
    const send=cloneTroops({
      INF:Math.floor(from.troops.INF/2),
      ARC:Math.floor(from.troops.ARC/2),
      CAV:Math.floor(from.troops.CAV/2)
    });
    if(sumTroops(send)>0){
      subTroops(from.troops, send);
      // ì ë„ ì˜ì›…ì´ ìˆìœ¼ë©´ ê°€ë” ë™í–‰(50% ì˜ˆì‹œ)
      let heroId=null;
      if(from.heroId && !heroes[from.heroId].inTransit && Math.random()<0.5){
        heroId=from.heroId; from.heroId=null; heroes[heroId].inTransit=true;
      }
      movements.push({from:from.id,to:to.id,owner:ENEMY,troops:send,heroId,turnsLeft:1});
      log(`(AI) í–‰êµ°: ${from.name} â†’ ${to.name} (ë³´${send.INF} ê¶${send.ARC} ê¸°${send.CAV}${heroId?`, ì˜ì›… ë™í–‰`:``})`);
    }
  }
}

/* ===== í„´ ì¢…ë£Œ ===== */
function endTurn(){
  gold+=incomeOf(PLAYER);
  resolveMovementsStepwise(); if(battleState){ updateTop(); draw(); refreshInfo(); return; }
  aiPhase();
  resolveMovementsStepwise(); if(battleState){ updateTop(); draw(); refreshInfo(); return; }
  turn++; updateTop(); draw(); refreshInfo();
}

/* ===== ì´ˆê¸°í™” ===== */
function bootstrap(){ updateTop(); refreshInfo(); draw(); log("ê²Œì„ ì‹œì‘. í”Œë ˆì´ì–´ì˜ í„´ì…ë‹ˆë‹¤."); }
bootstrap();
</script>
</body>
</html>
