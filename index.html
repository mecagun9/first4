<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>삼국지3 스타일 턴제 + 전투 + 병종 + 영웅 어드밴티지(통합)</title>
<style>
  body{margin:0;background:#1a1d24;color:#eaeaea;font-family:system-ui,apple-system,sans-serif}
  #wrap{display:flex;gap:12px;padding:12px}
  #left{flex:0 0 760px}
  #right{flex:1;display:flex;flex-direction:column;gap:8px}
  canvas{background:#0f1115;border:1px solid #333;border-radius:8px;display:block}
  .panel{background:#12151c;border:1px solid #2a2e38;border-radius:8px;padding:10px}
  h3{margin:0 0 8px 0;font-size:14px;color:#8bd0ff}
  button{background:#2a3242;border:1px solid #445169;color:#eaeaea;border-radius:6px;padding:8px 10px;cursor:pointer}
  button:disabled{opacity:.5;cursor:not-allowed}
  .row{display:flex;gap:6px;flex-wrap:wrap}
  .kv{font-size:12px;opacity:.95}
  input[type=number]{width:76px;background:#0f1115;color:#fff;border:1px solid #2a2e38;border-radius:6px;padding:6px}
  small{opacity:.8}

  /* 전투 오버레이 */
  #battleOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.65);z-index:9999}
  #battleBox{width:840px;background:#0f1115;border:1px solid #2a2e38;border-radius:10px;padding:16px}
  #battleLog{height:180px;overflow:auto;background:#11151d;border:1px solid #2a2e38;border-radius:8px;padding:8px;font-size:12px}
  .cols{display:flex;gap:12px}
  .col{flex:1}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{border:1px solid #2a2e38;padding:4px;text-align:center}
  .muted{opacity:.7}
</style>
</head>
<body>
<div id="wrap">
  <div id="left"><canvas id="map" width="760" height="600"></canvas></div>
  <div id="right">
    <div class="panel">
      <h3>턴 / 자원</h3>
      <div class="kv">현재 턴: <b id="turn">1</b></div>
      <div class="kv">금: <b id="gold">200</b> G</div>
      <div class="kv">수입(턴당): <b id="income">0</b> G</div>
      <div class="kv muted">모집 비용: 보병 1G / 궁수 2G / 기병 3G</div>
    </div>

    <div class="panel">
      <h3>거점 정보</h3>
      <div id="cityInfo" class="kv">거점을 클릭하세요.</div>
    </div>

    <div class="panel">
      <h3>명령</h3>
      <div class="row">
        <button id="btnMove" disabled>이동</button>
        <button id="btnRecruit" disabled>모집</button>
        <button id="btnFortify" disabled>요새화</button>
        <button id="btnCancel" disabled>취소</button>
      </div>
      <div id="cmdArea" style="margin-top:8px;"></div>
      <div style="margin-top:8px"><button id="btnEnd">턴 종료 ▶</button></div>
      <small>
        • 이동: 인접 거점만, 1턴 소요 → 적/중립 도착 시 <b>전투 화면</b><br>
        • 이동 명령창에서 <b>영웅 동행</b> 체크 가능 (해당 도시 배속 영웅)<br>
        • 모집: 병종별 비용 상이(상단 참고) • 요새화: 10G로 방어 +1 (최대 +5)
      </small>
    </div>

    <div class="panel">
      <h3>로그</h3>
      <div id="log" style="height:220px;overflow:auto;font-size:12px;line-height:1.4"></div>
    </div>
  </div>
</div>

<!-- 전투 오버레이 -->
<div id="battleOverlay">
  <div id="battleBox">
    <h3>전투</h3>
    <div id="battleHeader" class="kv">공격: ? → 방어: ?</div>

    <div class="row muted" style="gap:16px;margin:8px 0">
      <div>공격 영웅: <b id="attHeroName">없음</b></div>
      <div>방어 영웅: <b id="defHeroName">없음</b></div>
    </div>

    <div class="cols" style="margin-bottom:8px">
      <div class="col">
        <table>
          <thead><tr><th colspan="3">공격 병력</th></tr></thead>
          <tbody>
            <tr><td>보병</td><td>궁수</td><td>기병</td></tr>
            <tr><td id="attINF">0</td><td id="attARC">0</td><td id="attCAV">0</td></tr>
          </tbody>
        </table>
      </div>
      <div class="col">
        <table>
          <thead><tr><th colspan="3">수비 병력</th></tr></thead>
          <tbody>
            <tr><td>보병</td><td>궁수</td><td>기병</td></tr>
            <tr><td id="defINF">0</td><td id="defARC">0</td><td id="defCAV">0</td></tr>
          </tbody>
        </table>
        <div class="kv" style="margin-top:6px">방어: <b id="defDefense">0</b></div>
      </div>
    </div>

    <div class="row" style="margin-bottom:8px">
      <button id="btnBattleRound">다음 라운드</button>
      <button id="btnBattleAuto">자동 전투</button>
      <button id="btnBattleRetreat">공격 중지(퇴각)</button>
      <button id="btnBattleFinish" disabled>전투 종료(결과 반영)</button>
    </div>

    <div class="muted" style="margin-bottom:6px">
      ※ 영웅 어드밴티지: 적 병종 비율을 기반으로 피해 보정(오라+상성), 사기 보너스는 전투력에 가산
    </div>
    <div id="battleLog"></div>
  </div>
</div>

<script>
/* ===== 병종/비용/상성 ===== */
const TYPES=["INF","ARC","CAV"]; // 보병/궁수/기병
const TYPE_NAME={INF:"보병",ARC:"궁수",CAV:"기병"};
const TRAIN_COST={INF:1,ARC:2,CAV:3};
const COUNTER={
  INF:{INF:1.0,ARC:1.25,CAV:0.85},
  ARC:{INF:0.9,ARC:1.0,CAV:1.25},
  CAV:{INF:1.25,ARC:0.85,CAV:1.0}
};

/* ===== 영웅(샘플) ===== */
const heroes={
  H01:{id:"H01",name:"관영",inTransit:false,
       aura:{atkPct:0.10,defPct:0.05},
       advantage:{INF:0.20,ARC:0.10,CAV:0.00}, // 적 병종 비율 기반 추가 공격 보너스
       moraleBoost:5},
  H02:{id:"H02",name:"장광",inTransit:false,
       aura:{atkPct:0.05,defPct:0.10},
       advantage:{INF:0.00,ARC:0.20,CAV:0.10},
       moraleBoost:8}
};

/* ===== 기본 상수 및 상태 ===== */
const PLAYER="player", ENEMY="enemy", NEUT="neutral";
const cities=[
  {id:"JI",name:"계(계성)",x:120,y:90, owner:PLAYER, troops:{INF:30,ARC:6,CAV:4},defense:1,income:12,adj:["YE","BO"],heroId:"H01"},
  {id:"YE",name:"업",     x:210,y:120,owner:PLAYER, troops:{INF:20,ARC:6,CAV:4},defense:1,income:10,adj:["JI","BO","PU"],heroId:null},
  {id:"BO",name:"박",     x:170,y:180,owner:NEUT,   troops:{INF:12,ARC:2,CAV:1},defense:0,income:6, adj:["JI","YE","PU","CH"],heroId:null},
  {id:"PU",name:"부",     x:260,y:190,owner:ENEMY,  troops:{INF:20,ARC:6,CAV:4},defense:1,income:9, adj:["YE","BO","CH","LU"],heroId:"H02"},
  {id:"CH",name:"허/창",  x:220,y:250,owner:NEUT,   troops:{INF:8, ARC:1,CAV:1},defense:0,income:6, adj:["BO","PU","LU","RU"],heroId:null},
  {id:"LU",name:"낙양",   x:295,y:255,owner:ENEMY,  troops:{INF:18,ARC:4,CAV:3},defense:1,income:9, adj:["PU","CH","RU"],heroId:null},
  {id:"RU",name:"여남",   x:260,y:320,owner:NEUT,   troops:{INF:9, ARC:2,CAV:1},defense:0,income:6, adj:["CH","LU","SH"],heroId:null},
  {id:"SH",name:"수춘",   x:310,y:380,owner:ENEMY,  troops:{INF:16,ARC:4,CAV:2},defense:1,income:8, adj:["RU","GU"],heroId:null},
  {id:"GU",name:"광릉",   x:360,y:330,owner:NEUT,   troops:{INF:8, ARC:1,CAV:1},defense:0,income:6, adj:["SH","QH"],heroId:null},
  {id:"QH",name:"건업",   x:420,y:360,owner:ENEMY,  troops:{INF:18,ARC:6,CAV:4},defense:1,income:10,adj:["GU","HU"],heroId:null},
  {id:"HU",name:"회계",   x:520,y:390,owner:NEUT,   troops:{INF:7, ARC:2,CAV:1},defense:0,income:6, adj:["QH"],heroId:null},
  {id:"PI",name:"북평",   x:140,y:40, owner:NEUT,   troops:{INF:6, ARC:1,CAV:1},defense:0,income:5, adj:["JI"],heroId:null},
];
let turn=1,gold=200;
let movements=[]; // {from,to,owner,troops:{INF,ARC,CAV},heroId|null,turnsLeft}
let selectedId=null,mode="idle",moveFrom=null;

const logEl=document.getElementById("log");
const byId=id=>cities.find(c=>c.id===id);
const sumTroops=t=>TYPES.reduce((s,k)=>s+(t[k]||0),0);
function addTroops(a,b){TYPES.forEach(k=>a[k]=(a[k]||0)+(b[k]||0));}
function subTroops(a,b){TYPES.forEach(k=>a[k]=(a[k]||0)-(b[k]||0));}
function cloneTroops(t){return {INF:t.INF||0,ARC:t.ARC||0,CAV:t.CAV||0};}
function isAnyPositive(t){return TYPES.some(k=> (t[k]||0)>0 );}
function log(msg){const d=document.createElement("div");d.textContent=msg;logEl.appendChild(d);logEl.scrollTop=logEl.scrollHeight;}
function incomeOf(owner){return cities.filter(c=>c.owner===owner).reduce((s,c)=>s+c.income,0);}
function updateTop(){document.getElementById("turn").textContent=turn;document.getElementById("gold").textContent=gold;document.getElementById("income").textContent=incomeOf(PLAYER);}
function heroName(id){return id? heroes[id]?.name || "??" : "없음";}
function citySummary(c){
  return `【${c.name}】 ${c.owner===PLAYER?'플레이어':c.owner===ENEMY?'적':'중립'} | 병력:${sumTroops(c.troops)} (보${c.troops.INF} 궁${c.troops.ARC} 기${c.troops.CAV}) | 방어:${c.defense} | 수입:${c.income} | 영웅:${heroName(c.heroId)}`;
}
function refreshInfo(){const info=document.getElementById("cityInfo");if(!selectedId){info.textContent="거점을 클릭하세요.";return;}info.textContent=citySummary(byId(selectedId));}

/* ===== 맵 렌더링 ===== */
const canvas=document.getElementById("map");
const ctx=canvas.getContext("2d");
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // 연결선
  ctx.lineWidth=2;
  cities.forEach(c=>{c.adj.forEach(a=>{const t=byId(a);ctx.strokeStyle="#2c3647";ctx.beginPath();ctx.moveTo(c.x,c.y);ctx.lineTo(t.x,t.y);ctx.stroke();});});
  // 이동 점선
  movements.forEach(m=>{const s=byId(m.from),t=byId(m.to);ctx.setLineDash([6,6]);ctx.strokeStyle="#bbb";ctx.beginPath();ctx.moveTo(s.x,s.y);ctx.lineTo(t.x,t.y);ctx.stroke();ctx.setLineDash([]);});
  // 노드
  cities.forEach(c=>{
    ctx.beginPath();ctx.arc(c.x,c.y,18,0,Math.PI*2);
    ctx.fillStyle=c.owner===PLAYER?"#3aa76d":c.owner===ENEMY?"#d94a4a":"#777";
    ctx.fill();ctx.lineWidth=2;ctx.strokeStyle="#0e0e0e";ctx.stroke();
    if(c.id===selectedId){ctx.beginPath();ctx.arc(c.x,c.y,22,0,Math.PI*2);ctx.strokeStyle="#ffde6b";ctx.lineWidth=2;ctx.stroke();}
    if(c.defense>0){ctx.fillStyle="#ffde6b";ctx.font="12px sans-serif";ctx.textAlign="center";ctx.fillText("🛡"+c.defense, c.x, c.y+32);}
    if(c.heroId){ctx.fillStyle="#ffd27f";ctx.font="11px sans-serif";ctx.textAlign="center";ctx.fillText("★"+heroName(c.heroId), c.x, c.y+46);}
    ctx.fillStyle="#eaeaea";ctx.font="12px sans-serif";ctx.textAlign="center";
    ctx.fillText(c.name, c.x, c.y-26);
    ctx.fillText(`兵:${sumTroops(c.troops)}`, c.x, c.y-10);
  });
}
function cityAt(x,y){return cities.find(c=>{const dx=x-c.x,dy=y-c.y;return dx*dx+dy*dy<=18*18+8;})?.id||null;}

/* ===== 명령 UI ===== */
const btnMove=document.getElementById("btnMove");
const btnRecruit=document.getElementById("btnRecruit");
const btnFortify=document.getElementById("btnFortify");
const btnCancel=document.getElementById("btnCancel");
const btnEnd=document.getElementById("btnEnd");
const cmdArea=document.getElementById("cmdArea");

function setButtons(){
  const sel=selectedId?byId(selectedId):null;
  btnMove.disabled=!(sel && sel.owner===PLAYER && sumTroops(sel.troops)>0);
  btnRecruit.disabled=!(sel && sel.owner===PLAYER);
  btnFortify.disabled=!(sel && sel.owner===PLAYER && sel.defense<5 && gold>=10);
  btnCancel.disabled=(mode==="idle");
}
btnMove.onclick=()=>{
  if(!selectedId) return; mode="movePick"; moveFrom=selectedId;
  cmdArea.innerHTML=`<div class="kv">이동 대상 거점을 클릭하세요. (인접만)</div>`;
  setButtons();
};
btnRecruit.onclick=()=>{
  if(!selectedId) return; mode="recruit";
  const c=byId(selectedId);
  cmdArea.innerHTML=`
    <div class="kv">모집 수 (비용: 보1G/궁2G/기3G)</div>
    <div class="row">
      <div>보병: <input type="number" id="rcINF" min="0" value="0"></div>
      <div>궁수: <input type="number" id="rcARC" min="0" value="0"></div>
      <div>기병: <input type="number" id="rcCAV" min="0" value="0"></div>
      <button id="doRecruit">확인</button>
    </div>
  `;
  document.getElementById("doRecruit").onclick=()=>{
    const INF=+document.getElementById("rcINF").value||0;
    const ARC=+document.getElementById("rcARC").value||0;
    const CAV=+document.getElementById("rcCAV").value||0;
    const cost=INF*TRAIN_COST.INF + ARC*TRAIN_COST.ARC + CAV*TRAIN_COST.CAV;
    if(cost>gold){log(`금이 부족합니다. 필요:${cost}G, 보유:${gold}G`);return;}
    c.troops.INF+=INF;c.troops.ARC+=ARC;c.troops.CAV+=CAV;gold-=cost;
    log(`【${c.name}】 모집: 보${INF} 궁${ARC} 기${CAV} (-${cost}G)`); mode="idle"; cmdArea.innerHTML="";
    updateTop(); refreshInfo(); draw(); setButtons();
  };
  setButtons();
};
btnFortify.onclick=()=>{
  if(!selectedId) return; const c=byId(selectedId);
  if(c.defense>=5 || gold<10) return;
  c.defense+=1; gold-=10; log(`【${c.name}】 요새화 +1 (방어 ${c.defense}, 금:${gold})`);
  refreshInfo(); updateTop(); draw(); setButtons();
};
btnCancel.onclick=()=>{mode="idle";moveFrom=null;cmdArea.innerHTML="";setButtons();};
btnEnd.onclick=endTurn;

/* 맵 클릭 */
canvas.addEventListener("click",(e)=>{
  const rect=canvas.getBoundingClientRect(); const x=e.clientX-rect.left,y=e.clientY-rect.top;
  const hit=cityAt(x,y); if(!hit) return;
  selectedId=hit; refreshInfo(); setButtons(); draw();

  if(mode==="movePick" && moveFrom){
    if(moveFrom===hit) return;
    const from=byId(moveFrom), to=byId(hit);
    if(!from.adj.includes(to.id)){log("인접 거점만 이동할 수 있습니다.");return;}
    if(from.owner!==PLAYER){log("소유 거점에서만 이동할 수 있습니다.");return;}
    if(sumTroops(from.troops)<=0){log("병력이 없습니다.");return;}

    // 병종별 이동 + 영웅 동행 체크
    mode="idle";
    const heroChk = from.heroId ? `<label><input type="checkbox" id="chkHero" ${heroes[from.heroId].inTransit?'disabled':''}> 영웅 동행 (${heroName(from.heroId)})</label>` : `<span class="muted">영웅 없음</span>`;
    cmdArea.innerHTML=`
      <div class="kv">이동 병력 입력 (최대: 보${from.troops.INF} 궁${from.troops.ARC} 기${from.troops.CAV})</div>
      <div class="row">
        <div>보병: <input type="number" id="mvINF" min="0" max="${from.troops.INF}" value="${Math.min(from.troops.INF, Math.floor(from.troops.INF/2))}"></div>
        <div>궁수: <input type="number" id="mvARC" min="0" max="${from.troops.ARC}" value="${Math.min(from.troops.ARC, Math.floor(from.troops.ARC/2))}"></div>
        <div>기병: <input type="number" id="mvCAV" min="0" max="${from.troops.CAV}" value="${Math.min(from.troops.CAV, Math.floor(from.troops.CAV/2))}"></div>
      </div>
      <div class="kv" style="margin-top:6px">${heroChk}</div>
      <button id="doMove">이동</button>
    `;
    document.getElementById("doMove").onclick=()=>{
      const INF=+document.getElementById("mvINF").value||0;
      const ARC=+document.getElementById("mvARC").value||0;
      const CAV=+document.getElementById("mvCAV").value||0;
      const withHero = from.heroId && !heroes[from.heroId].inTransit && (document.getElementById("chkHero")?.checked||false);
      if(INF>from.troops.INF||ARC>from.troops.ARC||CAV>from.troops.CAV){log("병력 초과 입력입니다.");return;}
      if(INF+ARC+CAV<=0 && !withHero){log("이동 병력 또는 영웅 동행을 선택하세요.");return;}

      from.troops.INF-=INF; from.troops.ARC-=ARC; from.troops.CAV-=CAV;
      const mv={from:from.id,to:to.id,owner:from.owner,troops:{INF,ARC,CAV},heroId:withHero?from.heroId:null,turnsLeft:1};
      if(withHero){heroes[from.heroId].inTransit=true; from.heroId=null;}
      movements.push(mv);
      log(`행군: ${from.name} → ${to.name} (보${INF} 궁${ARC} 기${CAV}${withHero?`, 영웅 동행`:``})`);
      cmdArea.innerHTML=""; draw(); refreshInfo(); setButtons();
    };
    moveFrom=null;
  }
});

/* ===== 전투 오버레이 ===== */
const battleOverlay=document.getElementById("battleOverlay");
const battleHeader=document.getElementById("battleHeader");
const eAttINF=document.getElementById("attINF"),eAttARC=document.getElementById("attARC"),eAttCAV=document.getElementById("attCAV");
const eDefINF=document.getElementById("defINF"),eDefARC=document.getElementById("defARC"),eDefCAV=document.getElementById("defCAV");
const eDefDefense=document.getElementById("defDefense");
const eAttHeroName=document.getElementById("attHeroName");
const eDefHeroName=document.getElementById("defHeroName");
const battleLog=document.getElementById("battleLog");
const btnBattleRound=document.getElementById("btnBattleRound");
const btnBattleAuto=document.getElementById("btnBattleAuto");
const btnBattleRetreat=document.getElementById("btnBattleRetreat");
const btnBattleFinish=document.getElementById("btnBattleFinish");

let battleState=null;
// {attFrom,attOwner,toId,att:{},def:{},defense,attHeroId,defHeroId,finished,retreated}

function openBattle({attFrom, attOwner, toId, att, heroId}){
  const dest=byId(toId);
  battleState={
    attFrom, attOwner, toId,
    att: cloneTroops(att),
    def: cloneTroops(dest.troops),
    defense: dest.defense,
    attHeroId: heroId || null,
    defHeroId: dest.heroId || null,
    finished:false, retreated:false
  };
  battleLog.innerHTML="";
  battleHeader.textContent=`공격: ${byId(attFrom).name} (${attOwner}) → 방어: ${dest.name} (${dest.owner})`;
  eAttHeroName.textContent = heroName(battleState.attHeroId);
  eDefHeroName.textContent = heroName(battleState.defHeroId);
  syncBattleUI();
  battleOverlay.style.display="flex";
}
function syncBattleUI(){
  const s=battleState; if(!s) return;
  eAttINF.textContent=s.att.INF; eAttARC.textContent=s.att.ARC; eAttCAV.textContent=s.att.CAV;
  eDefINF.textContent=s.def.INF; eDefARC.textContent=s.def.ARC; eDefCAV.textContent=s.def.CAV;
  eDefDefense.textContent=s.defense;
  btnBattleFinish.disabled=!s.finished;
}

/* ===== 영웅 어드밴티지/오라/사기 버프 ===== */
function getHeroBuff(side, enemyTroops){
  const id = side==='att'? battleState.attHeroId : battleState.defHeroId;
  if(!id) return {atkMul:1, defMul:1, morale:0};
  const h=heroes[id]; const aura=h.aura||{}; const adv=h.advantage||{};
  const total=sumTroops(enemyTroops); let advBonus=0;
  if(total>0){ TYPES.forEach(tp=>{ const portion=(enemyTroops[tp]||0)/total; advBonus += (adv[tp]||0)*portion; }); }
  return { atkMul:1+(aura.atkPct||0)+advBonus, defMul:1+(aura.defPct||0), morale:h.moraleBoost||0 };
}

/* ===== 전투 1라운드 =====
   - 타입 상성(COUNTER) + 랜덤 + 영웅 오라/어드밴티지/사기
   - 수비는 요새(방어도)로 피해감소 및 반격 강화
*/
function battleRoundOnce(){
  const s=battleState; if(!s || s.finished) return;
  const rand=(a,b)=> a + Math.random()*(b-a);

  const attBuff=getHeroBuff('att', s.def);
  const defBuff=getHeroBuff('def', s.att);

  let defLoss={INF:0,ARC:0,CAV:0}, attLoss={INF:0,ARC:0,CAV:0};

  // 공격 -> 수비 피해 (상성 + 오라/어드밴티지 + 사기)
  TYPES.forEach(aType=>{
    const base = s.att[aType]; if(base<=0) return;
    TYPES.forEach(dType=>{
      const mult=COUNTER[aType][dType];
      const power = Math.floor( base * rand(0.18,0.26) * mult * attBuff.atkMul * (1 + attBuff.morale/100) );
      defLoss[dType] += power;
    });
  });

  // 수비 -> 공격 반격 (방어도 영향으로 강화)
  TYPES.forEach(dType=>{
    const base = s.def[dType]; if(base<=0) return;
    TYPES.forEach(aType=>{
      const mult=COUNTER[dType][aType];
      const power = Math.floor( base * rand(0.12,0.20) * mult * defBuff.defMul * (1 + defBuff.morale/100) * (1 + s.defense*0.08) );
      attLoss[aType] += power;
    });
  });

  // 방어도에 따른 수비 피해감소(수비측이 받는 피해)
  TYPES.forEach(t=>{
    defLoss[t] = Math.max(0, Math.floor(defLoss[t] * (1 - Math.min(0.45, s.defense*0.07))));
  });

  // 적용(0 하한)
  TYPES.forEach(t=>{
    s.def[t]=Math.max(0, s.def[t]-defLoss[t]);
    s.att[t]=Math.max(0, s.att[t]-attLoss[t]);
  });

  const line=`라운드 ▶ 수비피해(보${defLoss.INF} 궁${defLoss.ARC} 기${defLoss.CAV}) / 공격피해(보${attLoss.INF} 궁${attLoss.ARC} 기${attLoss.CAV})
   → 잔여: 공(보${s.att.INF} 궁${s.att.ARC} 기${s.att.CAV}) / 수(보${s.def.INF} 궁${s.def.ARC} 기${s.def.CAV})`;
  const d=document.createElement("div"); d.textContent=line; battleLog.appendChild(d); battleLog.scrollTop=battleLog.scrollHeight;

  if(!isAnyPositive(s.att) || !isAnyPositive(s.def)){ s.finished=true; }
  syncBattleUI();
}
btnBattleRound.onclick=battleRoundOnce;
btnBattleAuto.onclick=()=>{let guard=0;while(battleState && !battleState.finished && guard<64){battleRoundOnce();guard++;}};
btnBattleRetreat.onclick=()=>{if(!battleState||battleState.finished) return;battleState.retreated=true;battleState.finished=true;const d=document.createElement("div");d.innerHTML="<b>퇴각!</b>";battleLog.appendChild(d);battleLog.scrollTop=battleLog.scrollHeight;syncBattleUI();};
btnBattleFinish.onclick=()=>{
  const s=battleState; if(!s||!s.finished) return; const dest=byId(s.toId);

  if(s.retreated){
    // 공격 측 잔여 병력 귀환 + 영웅 복귀
    if(isAnyPositive(s.att)){ addTroops(byId(s.attFrom).troops, s.att); log(`퇴각: ${byId(s.attFrom).name}로 병력 귀환 (보${s.att.INF} 궁${s.att.ARC} 기${s.att.CAV})`); }
    if(s.attHeroId){ byId(s.attFrom).heroId=s.attHeroId; heroes[s.attHeroId].inTransit=false; log(`영웅 ${heroName(s.attHeroId)} 퇴각 후 ${byId(s.attFrom).name} 복귀`); }
  }else{
    const attSum=sumTroops(s.att), defSum=sumTroops(s.def);
    if(defSum<=0 && attSum>0){
      // 함락: 수비 영웅은 도주(슬롯 비움), 공격 영웅 부임
      if(s.defHeroId){ log(`수비 영웅 ${heroName(s.defHeroId)} 도주`); }
      dest.owner=s.attOwner; dest.troops=cloneTroops(s.att); dest.defense=Math.max(0,dest.defense-1);
      dest.heroId = s.attHeroId || null;
      if(s.attHeroId){ heroes[s.attHeroId].inTransit=false; }
      log(`함락! ${dest.name} 점령${s.attHeroId?` (영웅 ${heroName(s.attHeroId)} 부임)`:""}`);
    }else{
      // 방어 성공: 수비 잔존 유지, 공격 잔여는 출발지로 귀환, 영웅도 복귀
      dest.troops=cloneTroops(s.def);
      if(attSum>0){ addTroops(byId(s.attFrom).troops, s.att); log(`공격 실패. ${byId(s.attFrom).name}로 병력 귀환 (보${s.att.INF} 궁${s.att.ARC} 기${s.att.CAV})`);}
      if(s.attHeroId){ byId(s.attFrom).heroId=s.attHeroId; heroes[s.attHeroId].inTransit=false; log(`영웅 ${heroName(s.attHeroId)} 공격 실패 후 복귀`);}
      log(`방어 성공: ${dest.name} 잔존 (보${s.def.INF} 궁${s.def.ARC} 기${s.def.CAV})`);
    }
  }
  battleOverlay.style.display="none"; battleState=null; draw(); refreshInfo(); updateTop();
};

/* ===== 이동/전투 연결 ===== */
function resolveMovementsOrOpenBattles(){
  const idx=movements.findIndex(m=>m.turnsLeft<=0);
  if(idx===-1) return false;
  const m=movements[idx], dest=byId(m.to);

  if(dest.owner===m.owner){
    addTroops(dest.troops, m.troops);
    if(m.heroId){ dest.heroId=m.heroId; heroes[m.heroId].inTransit=false; log(`영웅 ${heroName(m.heroId)}이(가) ${dest.name}에 부임`); }
    log(`합류: ${dest.name} 에 병력 (보${m.troops.INF} 궁${m.troops.ARC} 기${m.troops.CAV})`);
    movements.splice(idx,1); return true;
  }else{
    openBattle({attFrom:m.from, attOwner:m.owner, toId:m.to, att:m.troops, heroId:m.heroId||null});
    movements.splice(idx,1); return true;
  }
}
function resolveMovementsStepwise(){
  for(let i=0;i<movements.length;i++){movements[i].turnsLeft--;}
  while(true){
    const progressed=resolveMovementsOrOpenBattles();
    if(!progressed) break;
    if(battleState) break; // 전투 발생 시 일시정지
  }
}

/* ===== AI (초기형) ===== */
function aiPhase(){
  const aiCities=cities.filter(c=>c.owner===ENEMY && sumTroops(c.troops)>=12);
  for(const from of aiCities){
    const targets=from.adj.map(id=>byId(id)).filter(t=>t.owner!==ENEMY);
    if(targets.length===0) continue;
    targets.sort((a,b)=>(sumTroops(a.troops)+a.defense*2)-(sumTroops(b.troops)+b.defense*2));
    const to=targets[0];
    const send=cloneTroops({
      INF:Math.floor(from.troops.INF/2),
      ARC:Math.floor(from.troops.ARC/2),
      CAV:Math.floor(from.troops.CAV/2)
    });
    if(sumTroops(send)>0){
      subTroops(from.troops, send);
      // 적도 영웅이 있으면 가끔 동행(50% 예시)
      let heroId=null;
      if(from.heroId && !heroes[from.heroId].inTransit && Math.random()<0.5){
        heroId=from.heroId; from.heroId=null; heroes[heroId].inTransit=true;
      }
      movements.push({from:from.id,to:to.id,owner:ENEMY,troops:send,heroId,turnsLeft:1});
      log(`(AI) 행군: ${from.name} → ${to.name} (보${send.INF} 궁${send.ARC} 기${send.CAV}${heroId?`, 영웅 동행`:``})`);
    }
  }
}

/* ===== 턴 종료 ===== */
function endTurn(){
  gold+=incomeOf(PLAYER);
  resolveMovementsStepwise(); if(battleState){ updateTop(); draw(); refreshInfo(); return; }
  aiPhase();
  resolveMovementsStepwise(); if(battleState){ updateTop(); draw(); refreshInfo(); return; }
  turn++; updateTop(); draw(); refreshInfo();
}

/* ===== 초기화 ===== */
function bootstrap(){ updateTop(); refreshInfo(); draw(); log("게임 시작. 플레이어의 턴입니다."); }
bootstrap();
</script>
</body>
</html>
